<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频内容分析工具</title>
    <!-- 添加html2canvas库用于网络摄像头画面捕获 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="icon" href="/static/icon/Unicom1.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --accent-color: #3f37c9;
            --secondary-color: #4cc9f0;
            --dark-color: #0b2545;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            padding-bottom: 60px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* 添加Unicom1背景层 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/static/icon/Unicom1.png');
            background-size: 40%;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 0.1;
            z-index: 1;
            pointer-events: none;
        }
        
        /* 添加白色半透明遮罩层 */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(248, 249, 250, 0.7);
            z-index: -1;
            pointer-events: none;
        }
        
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            color: white !important;
            font-weight: 600;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.85) !important;
            font-weight: 500;
        }
        
        .nav-link:hover {
            color: white !important;
        }
        
        /* 模型下拉菜单样式 */
        .dropdown-menu {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: none;
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 280px;
        }
        
        .model-dropdown-item {
            padding: 0.75rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .model-dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .model-dropdown-item.selected {
            background-color: #f0f7ff;
        }
        
        .dropdown-icon-container {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary-color);
            background-color: #f0f7ff;
            border-radius: 50%;
            margin-right: 0.75rem;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .dropdown-icon-container img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .dropdown-model-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #333;
        }
        
        .dropdown-model-description {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* 自定义元景图标样式 */
        .custom-yuanjing-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            background-image: url('/static/icon/yuanjing.jpeg');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            vertical-align: text-bottom;
        }
        
        .main-container {
            padding: 4.5rem 0 1rem 0; /* Increased top padding to account for fixed navbar plus extra space */
            max-width: 960px;
            margin: 0 auto;
            flex: 1;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        .card-body {
            padding: 1rem;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        .model-card {
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: white;
            transition: all 0.3s ease;
            height: 100%;
        }

        .model-card:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .model-card.selected {
            border-color: var(--primary-color);
            background-color: #f0f7ff;
        }

        .model-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary-color);
            background-color: #f0f7ff;
            border-radius: 50%;
            overflow: hidden;
        }
        
        .model-icon img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 50%;
        }

        .model-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .model-description {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.2;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-area.has-video {
            cursor: default;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            background: #fff;
            overflow: hidden;
        }

        .upload-area video {
            width: 100%;
            max-width: 640px;
            height: auto;
            max-height: 360px;
            object-fit: contain;
            margin: 0 auto;
            display: none;
            border-radius: 8px;
            background: #000;
        }

        .upload-area.has-video video {
            display: block;
        }

        .upload-area.has-video .upload-content {
            display: none;
        }
        
        .upload-area.has-image {
            cursor: default;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            background: #fff;
            overflow: hidden;
        }
        
        .upload-area.has-image img {
            display: block;
            max-width: 100%;
            max-height: 360px;
            margin: 0 auto;
            border-radius: 8px;
        }
        
        .upload-area.has-image .upload-content {
            display: none;
        }

        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }

        .upload-content h5 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            margin: 0.5rem 0;
            color: #666;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 0.75rem 2rem;
            font-weight: 500;
            border-radius: 8px;
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 0.75rem 2rem;
            font-weight: 500;
            border-radius: 8px;
        }

        .btn-primary:hover, .btn-outline-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-primary.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-outline-primary.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark-color);
        }

        #file-input {
            display: none;
        }

        .alert {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            z-index: 1050;
            min-width: 240px;
            max-width: 480px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .alert-success {
            border-left: 3px solid #059669;
        }

        .alert-success i {
            color: #059669;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-error {
            border-left: 3px solid #dc2626;
        }

        .alert-error i {
            color: #dc2626;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert .message-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
        }

        .alert .message-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1f2937;
            flex-shrink: 0;
        }

        .alert .message-content {
            color: #4b5563;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .video-section {
            display: none;
        }

        .video-section.active {
            display: block;
        }

        .stream-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            min-height: 360px;
            aspect-ratio: 16/9;
        }
        
        #streamVideo, #ipCameraVideo {
            width: 100%;
            height: 100%;
            object-fit: contain; /* 确保视频内容完全可见，不裁剪，可能有黑边 */
            background: #000; /* 黑色背景填充空白处 */
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .stream-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }

        .stream-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            background: #f8f9fa;
        }

        .stream-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .stream-container.active .stream-placeholder {
            display: none;
        }

        .stream-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            z-index: 10;
        }

        .stream-error {
            color: #dc2626;
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        .search-targets-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .chat-message {
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(20px);
            animation: messageAppear 0.3s ease forwards;
        }

        @keyframes messageAppear {
            to {
            opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.system {
            padding-left: 1rem;
            border-left: 3px solid var(--primary-color);
        }

        .chat-message.user {
            text-align: right;
            padding-right: 1rem;
            border-right: 3px solid var(--accent-color);
        }

        .message-content {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            max-width: 80%;
        }

        .chat-message.system .message-content {
            background: #f0f7ff;
            color: var(--dark-color);
        }

        .chat-message.user .message-content {
            background: var(--primary-color);
            color: white;
        }

        .chat-input-container {
            position: relative;
            margin-top: 1rem;
        }

        .chat-input-container input {
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .chat-input-container input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }

        .input-hint {
            position: absolute;
            left: 0;
            bottom: -1.5rem;
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-target-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .search-target-item:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .search-target-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            color: #333;
            position: relative;
            padding-left: 1.5rem;
        }

        .search-target-content:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 0.8rem;
            height: 0.8rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234361ee' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        .input-group {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .input-group .form-control {
            border: 1px solid #dee2e6;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
        }

        .input-group .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }

        .input-group .input-group-text {
            background: white;
            border: 1px solid #dee2e6;
            border-right: none;
            padding: 0.75rem;
        }

        .input-group .btn {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .input-group .btn-success {
            background-color: #10b981;
            border-color: #10b981;
            color: white;
        }

        .input-group .btn-success:hover {
            background-color: #059669;
            border-color: #059669;
        }

        .input-group .btn + .btn {
            margin-left: -1px;
        }

        .input-group .form-control:focus + .btn {
            border-left-color: var(--primary-color);
        }

        #targetHelpText {
            color: #666;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-message {
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .alert-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .alert-message.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .alert-message.success {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .search-results-container {
            max-height: 500px;
            overflow-y: auto;
            padding: 0.5rem;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .search-results-container::-webkit-scrollbar {
            width: 6px;
        }

        .search-results-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .search-results-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .search-results-container::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .result-item {
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: resultAppear 0.3s ease forwards;
        }

        @keyframes resultAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            padding: 0.75rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .result-timestamp {
            font-size: 0.85rem;
            color: #666;
        }

        .result-frame-number {
            font-size: 0.85rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        .result-content {
            display: flex;
            padding: 1rem;
            gap: 1rem;
        }

        .result-frame {
            width: 240px;
            height: 135px;
            background: #000;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .result-frame img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .result-description {
            margin-bottom: 0.75rem;
            color: #333;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .result-targets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .target-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .target-tag.found {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .target-tag.not-found {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .target-tag i {
            font-size: 0.9rem;
        }

        #noResultsMessage {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: #666;
        }

        #noResultsMessage i {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        #resultCount {
            font-size: 0.9rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }

        .frame-settings {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.75rem;
            font-size: 0.9rem;
        }
        
        .frame-settings .form-range {
            height: 1.25rem;
            margin: 0.25rem 0;
        }
        
        .frame-settings .form-range::-webkit-slider-thumb {
            background: var(--primary-color);
        }
        
        .frame-settings .form-range::-moz-range-thumb {
            background: var(--primary-color);
        }
        
        .frame-settings .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .frame-settings .form-label {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .frame-settings small {
            font-size: 0.75rem;
        }
        
        /* 添加网络摄像头样式 */
        .ipCamera-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }
        
        .ipCamera-placeholder i {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 16px;
        }
        
        .ipCamera-placeholder p {
            color: #6c757d;
            font-size: 16px;
            text-align: center;
            margin: 0;
        }
        
        /* RTSP输入框容器样式 */
        .rtsp-input-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            max-width: 800px;
        }
        
        .rtsp-input-container .input-group {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* 功能区域切换样式 */
        .feature-section {
            display: none;
        }
        
        .feature-section.active {
            display: block;
        }
        
        /* 功能切换按钮样式 */
        #searchModeBtn.active, #newFeatureBtn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        /* 新功能区域样式 */
        .new-feature-container {
            min-height: 300px;
        }
        
        .new-feature-container .alert {
            position: relative;
            opacity: 1;
            pointer-events: auto;
            transform: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            max-width: none;
        }
        
        /* 智能分析样式 */
        .chat-history {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-message.user {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        
        .chat-message.assistant {
            background-color: #f0f0f0;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        
        /* 添加样式支持带图像的消息 */
        .chat-message.with-image {
            max-width: 95%;
            padding: 0.75rem;
        }

        .chat-message .image-container {
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            overflow: hidden;
            max-width: 100%;
            text-align: center;
        }
        
        .chat-message .image-container img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 0.5rem;
            border: 1px solid #eee;
            background-color: #fff;
        }

        .chat-message .result-text {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .chat-message .more-result {
            border-top: 1px solid #e5e7eb;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
        }

        .chat-message .message-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
            text-align: right;
        }
        
        .chat-input-area {
            padding-top: 0.5rem;
            border-top: 1px solid #dee2e6;
        }
        
        .chat-input-area .input-group textarea {
            border-radius: 0.5rem 0 0 0.5rem;
            resize: none;
        }
        
        .chat-input-area .input-group button {
            border-radius: 0 0.5rem 0.5rem 0;
        }
        
        /* 打字指示器样式 */
        .typing-indicator {
            background-color: #f0f0f0;
            padding: 0.5rem 1rem;
        }
        
        .typing-indicator .dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            margin-right: 2px;
            background: #666;
            animation: wave 1.3s linear infinite;
        }
        
        @keyframes wave {
            0%, 60%, 100% {
                transform: initial;
            }
            30% {
                transform: translateY(-5px);
            }
        }

        /* 分析状态指示器样式 */
        .analysis-status-indicator {
            display: none;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .analysis-status-indicator .status-text {
            font-size: 0.9rem;
            color: #666;
            margin-right: 1rem;
        }
        
        .analysis-status-indicator .progress {
            height: 6px;
            border-radius: 3px;
        }

        .analysis-status-indicator .progress-bar {
            background-color: #4361ee;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* 特定场景样式 */
        .scenario-option {
            width: 110px;
            height: 70px; /* 从90px减小到70px */
            border-radius: 10px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem; /* 从0.75rem减小到0.5rem */
        }
        
        .scenario-option:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .scenario-option.selected {
            background-color: #e6f4ff;
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .scenario-icon {
            font-size: 1.75rem; /* 从2rem减小到1.75rem */
            color: var(--primary-color);
            margin-bottom: 0.3rem; /* 从0.5rem减小到0.3rem */
        }
        
        .scenario-name {
            font-size: 0.85rem; /* 从0.9rem减小到0.85rem */
            font-weight: 600;
            text-align: center;
        }
        
        .scenario-result {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary-color);
            animation: fadeIn 0.3s ease;
        }
        
        .scenario-timestamp {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .scenario-result-content {
            display: flex;
            gap: 1rem;
        }
        
        .scenario-frame {
            width: 240px;
            height: 135px;
            background: #000;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .scenario-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scenario-info {
            flex: 1;
        }
        
        .scenario-description {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .scenario-video-time {
            font-size: 0.85rem;
            color: var(--primary-color);
            font-weight: 500;
            margin-top: 0.5rem;
        }
        
        .section-subtitle {
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- 添加提示框 -->
    <div class="alert alert-success" id="successAlert" role="alert">
        <i class="bi bi-check-circle-fill"></i>
        <div class="message-container">
            <div class="message-title">提示</div>
            <div class="message-content">操作成功</div>
        </div>
    </div>
    <div class="alert alert-error" id="errorAlert" role="alert">
        <i class="bi bi-exclamation-circle-fill"></i>
        <div class="message-container">
            <div class="message-title">错误</div>
            <div class="message-content" id="errorMessage">操作失败</div>
        </div>
    </div>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="/static/icon/Unicom1.png" alt="联通" style="width: 36px; height: 28px; object-fit: contain; margin-right: 10px;"> 视频内容分析工具
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="modelDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-gear"></i> 模型
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="modelDropdown">
                            <li>
                                <a class="dropdown-item model-dropdown-item" href="#" onclick="selectModel('qwen')" id="qwen-dropdown-item">
                                    <div class="d-flex align-items-center">
                                        <div class="dropdown-icon-container">
                                            <img src="/static/icon/qwen.jpg" alt="Qwen">
                                        </div>
                                        <div>
                                            <div class="dropdown-model-title">Qwen2.5-VL</div>
                                            <div class="dropdown-model-description">阿里通义千问视觉模型</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item model-dropdown-item" href="#" onclick="selectModel('douban')" id="douban-dropdown-item">
                                    <div class="d-flex align-items-center">
                                        <div class="dropdown-icon-container">
                                            <img src="/static/icon/doubao.jpg" alt="豆包">
                                        </div>
                                        <div>
                                            <div class="dropdown-model-title">豆包</div>
                                            <div class="dropdown-model-description">火山引擎视觉分析模型</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item model-dropdown-item" href="#" onclick="selectModel('gemini')" id="gemini-dropdown-item">
                                    <div class="d-flex align-items-center">
                                        <div class="dropdown-icon-container">
                                            <i class="bi bi-google"></i>
                                        </div>
                                        <div>
                                            <div class="dropdown-model-title">Gemini</div>
                                            <div class="dropdown-model-description">Google 多模态模型</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item model-dropdown-item" href="#" onclick="selectModel('minimax')" id="minimax-dropdown-item">
                                    <div class="d-flex align-items-center">
                                        <div class="dropdown-icon-container">
                                            <img src="/static/icon/Minimax.jpg" alt="MiniMax">
                                        </div>
                                        <div>
                                            <div class="dropdown-model-title">MiniMax</div>
                                            <div class="dropdown-model-description">国产视觉分析模型</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item model-dropdown-item" href="#" onclick="selectModel('kimi')" id="kimi-dropdown-item">
                                    <div class="d-flex align-items-center">
                                        <div class="dropdown-icon-container">
                                            <img src="/static/icon/kimi.png" alt="Kimi">
                                        </div>
                                        <div>
                                            <div class="dropdown-model-title">Kimi</div>
                                            <div class="dropdown-model-description">Moonshot AI 多模态模型</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item model-dropdown-item" href="#" onclick="selectModel('llama_scout')" id="llama_scout-dropdown-item">
                                    <div class="d-flex align-items-center">
                                        <div class="dropdown-icon-container">
                                            <img src="/static/icon/yuanjing.jpeg" alt="元景">
                                        </div>
                                        <div>
                                            <div class="dropdown-model-title">联通元景</div>
                                            <div class="dropdown-model-description">联通元景大模型</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="container main-container">
        <!-- 模型选择区域 - 隐藏，因为已移至导航栏下拉菜单 -->
        <div class="card mb-4" style="display: none;">
            <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-cpu"></i> 选择分析模型
                </h5>
                <div class="row g-2">
                    <div class="col-md-3 col-sm-6">
                        <div class="model-card" onclick="selectModel('qwen')" id="qwen-model">
                            <div class="model-icon">
                                <img src="/static/icon/qwen.jpg" alt="Qwen">
                            </div>
                            <div class="model-title">Qwen2.5-VL</div>
                            <div class="model-description">阿里通义千问视觉模型</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="model-card" onclick="selectModel('douban')" id="douban-model">
                            <div class="model-icon">
                                <img src="/static/icon/doubao.jpg" alt="豆包">
                            </div>
                            <div class="model-title">豆包</div>
                            <div class="model-description">火山引擎视觉分析模型</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="model-card" onclick="selectModel('gemini')" id="gemini-model">
                            <div class="model-icon">
                                <i class="bi bi-google"></i>
                            </div>
                            <div class="model-title">Gemini</div>
                            <div class="model-description">Google 多模态模型</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="model-card" onclick="selectModel('minimax')" id="minimax-model">
                            <div class="model-icon">
                                <img src="/static/icon/Minimax.jpg" alt="MiniMax">
                            </div>
                            <div class="model-title">MiniMax</div>
                            <div class="model-description">国产视觉分析模型</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="model-card" onclick="selectModel('kimi')" id="kimi-model">
                            <div class="model-icon">
                                <img src="/static/icon/kimi.png" alt="Kimi">
                            </div>
                            <div class="model-title">Kimi</div>
                            <div class="model-description">Moonshot AI's multimodal model with strong visual understanding capabilities.</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="model-card" onclick="selectModel('llama_scout')" id="llama_scout-model">
                            <div class="model-icon" style="background: transparent; padding: 0; overflow: hidden;">
                                <img src="/static/icon/yuanjing.jpeg" alt="元景" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                            </div>
                            <div class="model-title">联通元景</div>
                            <div class="model-description">联通元景大模型</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分析方式选择 -->
        <div class="card mb-4">
                        <div class="card-body">
                <h5 class="section-title">选择视频方式</h5>
                <div class="d-flex justify-content-center gap-4">
                    <button class="btn btn-primary active" id="uploadBtn" onclick="switchVideoMode('upload')">
                                    <i class="bi bi-upload"></i> 上传视频分析
                                </button>
                    <button class="btn btn-outline-primary" id="streamBtn" onclick="switchVideoMode('stream')">
                                    <i class="bi bi-camera-video"></i> 本地摄像头分析
                                </button>
                    <button class="btn btn-outline-primary" id="ipCameraBtn" onclick="switchVideoMode('ipCamera')">
                                    <i class="bi bi-webcam"></i> 网络摄像头分析
                                </button>
                    <button class="btn btn-outline-primary" id="imageBtn" onclick="switchVideoMode('image')">
                                    <i class="bi bi-image"></i> 图片分析
                                </button>
                </div>
            </div>
                            </div>

        <!-- 上传视频分析区域 -->
        <div class="card video-section active" id="uploadSection">
                                        <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-upload"></i> 上传视频
                </h5>
                <div class="upload-area" id="dropZone">
                    <input type="file" id="file-input" accept="video/mp4,video/avi,video/mov,video/mkv">
                    <div class="upload-content">
                                                    <i class="bi bi-cloud-upload upload-icon"></i>
                                                    <h5>拖放视频文件到这里</h5>
                        <p class="upload-text">或者点击选择文件</p>
                                                </div>
                    <video id="videoPreview" controls>
                        您的浏览器不支持 video 标签。
                                                        </video>
                                                            </div>
                
                <!-- 抽帧设置 -->
                <div class="frame-settings mt-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <label for="frameInterval" class="form-label">
                            <i class="bi bi-clock"></i> 抽帧间隔: <span id="frameIntervalValue">2</span> 秒
                        </label>
                    </div>
                    <input type="range" class="form-range" id="frameInterval" 
                           min="0.5" max="10" step="0.5" value="2">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">0.5秒</small>
                        <small class="text-muted">10秒</small>
                    </div>
                </div>
                                                    </div>
                                                </div>

        <!-- 本地摄像头分析区域 -->
        <div class="card video-section" id="streamSection">
            <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-camera-video"></i> 本地摄像头
                </h5>
                <div class="stream-container">
                    <video id="streamVideo" autoplay playsinline></video>
                    <div class="stream-placeholder">
                        <i class="bi bi-camera-video"></i>
                        <p>正在准备本地摄像头...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 网络摄像头分析区域 -->
        <div class="card video-section" id="ipCameraSection">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="section-title mb-0">
                        <i class="bi bi-webcam"></i> 网络摄像头
                    </h5>
                    
                    <!-- 输入框移至标题右侧 -->
                    <div class="rtsp-input-container flex-grow-1 ms-3">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-camera"></i>
                            </span>
                            <input type="text" 
                                class="form-control" 
                                id="ipCameraInput" 
                                placeholder="请输入RTSP地址，如: rtsp://用户名:密码@摄像头IP:端口/视频路径"
                                aria-label="摄像头地址">
                            <button class="btn btn-primary" type="button" id="connectCameraBtn">
                                <i class="bi bi-play-fill"></i> 连接
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="stream-container">
                    <div class="ipCamera-placeholder" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:50px 20px; background-color:#f8f9fa; border-radius:8px; border:2px dashed #dee2e6;">
                        <i class="bi bi-webcam" style="font-size:48px; color:#6c757d; margin-bottom:16px;"></i>
                        <p style="color:#6c757d; font-size:16px; text-align:center; margin:0;">请输入RTSP地址并点击连接按钮</p>
                        <p style="color:#6c757d; font-size:14px; text-align:center; margin-top:10px;">支持连接到网络摄像头、NVR设备或其他RTSP视频源</p>
                    </div>
                    <!-- 视频元素将由JS动态创建 -->
                </div>
                
                <!-- 添加状态显示区域 -->
                <div id="rtspStatusBar" class="alert alert-info mt-3" style="display:none;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle"></i>
                        <span id="rtspStatusMessage"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图片分析区域 -->
        <div class="card video-section" id="imageSection">
            <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-image"></i> 图片分析
                </h5>
                <div class="upload-area" id="imageDropZone">
                    <input type="file" id="image-input" accept="image/jpeg,image/png,image/jpg,image/gif">
                    <div class="upload-content">
                        <i class="bi bi-image upload-icon"></i>
                        <h5>拖放图片文件到这里</h5>
                        <p class="upload-text">或者点击选择图片（支持JPG、PNG、GIF）</p>
                    </div>
                    <img id="imagePreview" style="display:none; max-width:100%; max-height:400px; margin:0 auto;">
                </div>
            </div>
        </div>

        <!-- 功能切换卡片 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-toggles"></i> 功能选择
                </h5>
                <div class="d-flex justify-content-center gap-4">
                    <button class="btn btn-primary active" id="searchModeBtn" onclick="switchFeatureMode('search')">
                        <i class="bi bi-search"></i> 目标搜索
                    </button>
                    <button class="btn btn-outline-primary" id="newFeatureBtn" onclick="switchFeatureMode('newFeature')">
                        <i class="bi bi-magic"></i> 智能分析
                    </button>
                    <button class="btn btn-outline-primary" id="scenarioModeBtn" onclick="switchFeatureMode('scenario')">
                        <i class="bi bi-building-gear"></i> 特定场景
                    </button>
                </div>
            </div>
        </div>

        <!-- 搜索目标卡片 -->
        <div class="card mb-4 feature-section active" id="searchTargetCard">
            <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-search"></i> 搜索目标
                </h5>
                <div class="search-targets-container">
                    <!-- 搜索目标列表 -->
                    <div id="searchTargetsList" class="mb-3"></div>
                    
                    <!-- 输入区域 -->
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               id="targetInput" 
                               placeholder="请输入要搜索的目标，如：戴眼镜的男性、红色轿车等"
                               aria-label="搜索目标"
                               aria-describedby="targetHelpText">
                        <button class="btn btn-primary" type="button" id="addTargetBtn">
                            <i class="bi bi-plus-lg"></i> 添加
                        </button>
                        <div class="d-flex">
                            <button class="btn btn-success" type="button" id="analyzeBtn">
                                <i class="bi bi-play-fill"></i> 开始分析
                            </button>
                            <button class="btn btn-danger" type="button" id="stopAnalyzeBtn" style="display:none;">
                                <i class="bi bi-stop-fill"></i> 停止
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索结果卡片 -->
        <div class="card mb-4 feature-section active" id="searchResultCard">
            <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-list-ul"></i> 分析结果
                    <span class="badge bg-primary float-end" id="resultCount">0</span>
                </h5>
                <div class="search-results-container">
                    <!-- 结果列表 -->
                    <div id="searchResultsList"></div>
                    
                    <!-- 无结果提示 -->
                    <div id="noResultsMessage" class="text-center text-muted py-4">
                        <i class="bi bi-inbox-fill"></i>
                        <p>暂无分析结果</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新功能卡片 -->
        <div class="card mb-4 feature-section" id="newFeatureCard" style="display: none;">
            <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-chat-dots"></i> 智能分析
                </h5>
                <div class="new-feature-container">
                    <!-- 对话历史显示区域 -->
                    <div class="chat-input-area mb-3">
                        <div class="input-group">
                            <textarea class="form-control" id="chatInput" rows="2" 
                                     placeholder="请输入您想分析的问题或内容（例如：这是一个交换机，请分析这个交换机是否正常运行）">数数画面中有几个灯</textarea>
                            <button class="btn btn-primary" type="button" id="sendChatBtn">
                                <i class="bi bi-send"></i> 开始分析
                            </button>
                            <button class="btn btn-danger" type="button" id="stopIntelligentAnalysisBtn" style="display:none;">
                                <i class="bi bi-stop-fill"></i> 停止
                            </button>
                        </div>
                    </div>
                    
                    <!-- 对话历史显示区域 - 移至下方 -->
                    <div class="chat-display-container mt-3">
                        <div class="card">
                            <div class="card-body p-3">
                                <div id="chatHistory" class="chat-history mb-3" style="height: 300px; overflow-y: auto;">
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-chat-square-text" style="font-size: 2rem;"></i>
                                        <p class="mt-2">智能分析结果</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 特定场景卡片 -->
        <div class="card mb-4 feature-section" id="scenarioCard" style="display: none;">
            <div class="card-body">
                <h5 class="section-title">
                    <i class="bi bi-building-gear"></i> 特定场景
                </h5>
                <!-- 场景选择卡片 -->
                <div class="card mb-3">
                    <div class="card-body py-2">
                        <h6 class="section-subtitle mb-2">
                            <i class="bi bi-list-check"></i> 场景选择
                        </h6>
                        <div class="d-flex flex-wrap justify-content-center gap-3 mt-2">
                            <div class="scenario-option" data-scenario="server-room">
                                <div class="scenario-icon">
                                    <i class="bi bi-hdd-rack"></i>
                                </div>
                                <div class="scenario-name">机房监测</div>
                            </div>
                            <div class="scenario-option" data-scenario="pollution">
                                <div class="scenario-icon">
                                    <i class="bi bi-trash"></i>
                                </div>
                                <div class="scenario-name">污染防治</div>
                            </div>
                            <div class="scenario-option" data-scenario="fire">
                                <div class="scenario-icon">
                                    <i class="bi bi-fire"></i>
                                </div>
                                <div class="scenario-name">火灾检测</div>
                            </div>
                            <div class="scenario-option" data-scenario="illegal-parking">
                                <div class="scenario-icon">
                                    <i class="bi bi-car-front"></i>
                                </div>
                                <div class="scenario-name">违停检测</div>
                            </div>
                            <div class="scenario-option" data-scenario="custom">
                                <div class="scenario-icon">
                                    <i class="bi bi-plus-circle"></i>
                                </div>
                                <div class="scenario-name">待添加</div>
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-success btn-sm" type="button" id="startScenarioBtn">
                                    <i class="bi bi-play-fill"></i> 开始分析
                                </button>
                                <button class="btn btn-danger btn-sm ms-2" type="button" id="stopScenarioBtn" style="display:none;">
                                    <i class="bi bi-stop-fill"></i> 停止
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 场景分析结果卡片 -->
                <div class="card">
                    <div class="card-body">
                        <h6 class="section-subtitle">
                            <i class="bi bi-clipboard-data"></i> 场景分析结果
                        </h6>
                        <div id="scenarioResultsContainer" class="mt-3" style="height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-buildings" style="font-size: 2rem;"></i>
                                <p class="mt-2">请选择场景并开始分析</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/controllers/uiController.js"></script>
    <script src="/static/js/config/state.js"></script>
    <script src="/static/js/controllers/fileController.js"></script>
    <script src="/static/js/controllers/streamController.js"></script>
    <script src="/static/js/controllers/ipCameraController.js"></script>
    <script src="/static/js/controllers/analysisController.js"></script>
    <script src="/static/js/utils/model-api-service.js"></script>
    <script>
        // 常量配置
        const CONFIG = {
            maxFileSize: 100 * 1024 * 1024, // 100MB
            validVideoTypes: ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-matroska'],
            alertDuration: 3000, // 延长提示窗口显示时间，从500ms改为3000ms
            defaultModel: 'qwen',
            defaultFrameInterval: 2,
            minFrameInterval: 0.5,
            maxFrameInterval: 10,
            maxResultsCount: 100,
            maxLocalCameraFrames: 100, // 原 maxStreamFrames
            analysisDelay: 1000,
            frameQuality: 0.8,
            // MediaMTX配置
            mediaMtx: {
                baseUrl: 'http://localhost:8889', // MediaMTX WebRTC服务地址
                defaultPath: 'camera1',            // 默认的摄像头路径
                apiUrl: 'http://localhost:8887'    // MediaMTX API地址
            }
        };

        // 注意：出于安全考虑，已移除前端硬编码的API密钥
        // API密钥现在通过后端配置文件和环境变量管理
        // 请在config.py和环境变量中配置相应的API密钥
        const MODEL_CONFIG = {
            // API配置已移至后端处理，避免密钥泄露
        };

        // 状态管理
        const state = {
            selectedModel: CONFIG.defaultModel,
            hasUploadedVideo: false,
            currentVideoURL: null,
            isProcessing: false,
            localCameraActive: false, // 原 streamActive
            ipCameraActive: false,
            ipCameraUrl: null,
            reconnectTimer: null,  // 用于自动重连的计时器
            mediaStream: null,
            searchTargets: [],
            searchResults: [],
            resultCount: 0,
            videoName: '',
            frameCount: 0,
            extractedFrames: [],
            currentFrameIndex: 0,
            currentMode: 'upload',
            localCameraFrameInterval: CONFIG.defaultFrameInterval, // 原 streamFrameInterval
            localCameraFrameTimer: null, // 原 streamFrameTimer
            streamExtractedFrames: [],
            isAnalyzing: false,
            manualDisconnect: false,
        };

        // DOM元素缓存
        const elements = {
            init() {
                this.dropZone = document.getElementById('dropZone');
                this.fileInput = document.getElementById('file-input');
                this.videoPreview = document.getElementById('videoPreview');
                this.uploadBtn = document.getElementById('uploadBtn');
                this.localCameraBtn = document.getElementById('streamBtn'); // 保留ID但变量名改变
                this.ipCameraBtn = document.getElementById('ipCameraBtn');
                this.imageBtn = document.getElementById('imageBtn');
                this.uploadSection = document.getElementById('uploadSection');
                this.localCameraSection = document.getElementById('streamSection'); // 保留ID但变量名改变
                this.ipCameraSection = document.getElementById('ipCameraSection');
                this.imageSection = document.getElementById('imageSection');
                this.imageDropZone = document.getElementById('imageDropZone');
                this.imageInput = document.getElementById('image-input');
                this.imagePreview = document.getElementById('imagePreview');
                this.ipCameraVideo = document.getElementById('ipCameraVideo');
                this.ipCameraInput = document.getElementById('ipCameraInput');
                this.connectCameraBtn = document.getElementById('connectCameraBtn');
                this.successAlert = document.getElementById('successAlert');
                this.errorAlert = document.getElementById('errorAlert');
                this.errorMessage = document.getElementById('errorMessage');
                this.localCameraVideo = document.getElementById('streamVideo'); // 保留ID但变量名改变
                this.localCameraContainer = document.querySelector('.stream-container'); // 类名保持不变，但变量名更改
                this.uploadContent = document.querySelector('.upload-content');
                this.searchTargetsContainer = document.querySelector('.search-targets-container');
                this.searchTargetsList = document.getElementById('searchTargetsList');
                this.targetInput = document.getElementById('targetInput');
                this.addTargetBtn = document.getElementById('addTargetBtn');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.stopAnalyzeBtn = document.getElementById('stopAnalyzeBtn');
                this.searchResultsList = document.getElementById('searchResultsList');
                this.noResultsMessage = document.getElementById('noResultsMessage');
                this.resultCount = document.getElementById('resultCount');
                this.frameInterval = document.getElementById('frameInterval');
                this.frameIntervalValue = document.getElementById('frameIntervalValue');
                this.localCameraFrameInterval = document.getElementById('streamFrameInterval'); // 保留ID但变量名改变
                this.localCameraFrameIntervalValue = document.getElementById('streamFrameIntervalValue'); // 保留ID但变量名改变
            }
        };

        // 工具函数
        const utils = {
            isValidVideoType(type) {
                return CONFIG.validVideoTypes.includes(type);
            },

            isValidFileSize(size) {
                return size <= CONFIG.maxFileSize;
            },

            // 安全地创建和跟踪blob URL
            createSafeBlobURL(blob) {
                try {
                    const url = URL.createObjectURL(blob);
                    // 确保blobUrls数组存在
                    if (!state.blobUrls) {
                        state.blobUrls = [];
                    }
                    // 跟踪创建的URL以便以后清理
                    state.blobUrls.push(url);

                    return url;
                } catch (error) {
                    console.error('创建Blob URL时出错:', error);
                    return null;
                }
            },
            
            // 安全地释放blob URL
            revokeBlobURL(url) {
                if (!url) return;
                
                try {
                    URL.revokeObjectURL(url);

                    
                    // 从跟踪数组中移除
                    if (state.blobUrls) {
                        const index = state.blobUrls.indexOf(url);
                        if (index !== -1) {
                            state.blobUrls.splice(index, 1);
                        }
                    }
                } catch (error) {
                    console.error('释放Blob URL时出错:', error);
                }
            },
            
            clearVideoResource() {
                try {
                    if (state.currentVideoURL) {
                        this.revokeBlobURL(state.currentVideoURL);
                        state.currentVideoURL = null;
                    }
                } catch (error) {
                    console.error('清理视频资源时出错:', error);
                }
            },

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            throttle(func, limit) {
                let inThrottle;
                return function executedFunction(...args) {
                    if (!inThrottle) {
                        func(...args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },
            
            // 添加内存管理工具函数
            clearTimeouts() {
                // 清除所有弹窗的超时
                const alerts = [elements.successAlert, elements.errorAlert];
                alerts.forEach(alert => {
                    if (alert && alert.dataset.hideTimeout) {
                        clearTimeout(parseInt(alert.dataset.hideTimeout));
                        delete alert.dataset.hideTimeout;
                    }
                });
                
                // 清除其他可能存在的超时
                if (state.localCameraFrameTimer) {
                    clearTimeout(state.localCameraFrameTimer);
                    state.localCameraFrameTimer = null;
                }
            },
            
            // 图像内存优化
            optimizeMemory() {
                // 限制结果列表的长度，防止内存占用过大
                if (state.searchResults.length > CONFIG.maxResultsCount) {
                    state.searchResults = state.searchResults.slice(0, CONFIG.maxResultsCount);
                }
                
                // 清理大量帧数据以释放内存
                if (state.streamExtractedFrames && state.streamExtractedFrames.length > 100) {
                    
                    // 找出分析过的帧索引
                    const analyzedFrameIndexes = new Set();
                    state.searchResults.forEach(result => {
                        if (result.frameNumber) {
                            analyzedFrameIndexes.add(result.frameNumber - 1);
                        }
                    });
                    
                    // 仅保留已分析的帧和当前处理位置附近的帧
                    const currentIndex = analysisController.currentFrameIndex;
                    const buffer = 10; // 前后各保留10帧
                    
                    // 记录要移除的帧 
                    const framesToRemove = [];
                    const framesToKeep = [];
                    
                    state.streamExtractedFrames.forEach((frame, index) => {
                        if (analyzedFrameIndexes.has(index) || 
                            (index >= currentIndex - buffer && index <= currentIndex + buffer)) {
                            framesToKeep.push(frame);
                        } else {
                            framesToRemove.push(frame);
                        }
                    });
                    
                    // 更新帧数组以释放内存
                    if (framesToRemove.length > 0 && framesToKeep.length > 0) {
                        state.streamExtractedFrames = framesToKeep;
                        
                        // 帮助浏览器释放内存
                        setTimeout(() => {
                            framesToRemove.length = 0; // 清空数组
                        }, 100);
                    }
                }
                
                // 清理可能存在的其他Blob URLs
                if (state.blobUrls && state.blobUrls.length > 0) {
                    state.blobUrls.forEach(url => {
                        try {
                            URL.revokeObjectURL(url);
                        } catch (e) {
                            console.warn('撤销Blob URL时出错:', e);
                        }
                    });
                    state.blobUrls = [];
                }
                
                // 主动触发垃圾回收
                if (window.gc) {
                    window.gc();
                }
            },
            
            // 定期执行内存优化
            setupMemoryManager() {
                // 每30秒进行一次内存优化
                const memoryInterval = setInterval(() => {
                    this.optimizeMemory();
                }, 30000);
                
                // 页面卸载时清理
                window.addEventListener('beforeunload', () => {
                    clearInterval(memoryInterval);
                    this.clearTimeouts();
                    this.optimizeMemory();
                });
            }
        };

        // UI控制器
        const uiController = {
            showAlert(type, message) {
                try {
                    const alert = type === 'success' ? elements.successAlert : 
                                 type === 'error' ? elements.errorAlert : 
                                 elements.successAlert;
                    
                    if (type === 'error') {
                        elements.errorMessage.textContent = message;
                    } else if (type === 'info') {
                        elements.successAlert.querySelector('.message-title').textContent = '提示';
                        elements.successAlert.querySelector('.message-content').textContent = message;
                    }
                    
                    alert.classList.add('show');
                    
                    // 使用 requestAnimationFrame 优化动画性能
                    const hideTimeout = setTimeout(() => {
                        alert.classList.remove('show');
                    }, CONFIG.alertDuration);
                    
                    // 保存超时ID以便在需要时清除
                    alert.dataset.hideTimeout = hideTimeout;
                } catch (error) {
                    console.error('显示提示框时出错:', error);
                }
            },

            resetUploadArea() {
                try {
                    elements.dropZone.classList.remove('has-video');
                    elements.dropZone.style.borderColor = '#ccc';
                    elements.dropZone.style.backgroundColor = 'white';
                    elements.fileInput.value = '';
                    state.hasUploadedVideo = false;
                } catch (error) {
                    console.error('重置上传区域时出错:', error);
                }
            },

            updateModelSelection(model) {
                try {
                    // 更新原始模型卡片
                    document.querySelectorAll('.model-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    const modelCard = document.getElementById(`${model}-model`);
                    if (modelCard) {
                        modelCard.classList.add('selected');
                    }
                    
                    // 更新下拉菜单中的选择状态
                    document.querySelectorAll('.model-dropdown-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    const dropdownItem = document.getElementById(`${model}-dropdown-item`);
                    if (dropdownItem) {
                        dropdownItem.classList.add('selected');
                    }
                    
                    // 更新导航栏中模型按钮的显示
                    const modelDropdown = document.getElementById('modelDropdown');
                    if (modelDropdown) {
                        // 根据所选模型设置不同的图标
                        let iconHtml = '<i class="bi bi-gear"></i>';
                        let modelName = '模型';
                        
                        switch(model) {
                            case 'kimi':
                                iconHtml = '<img src="/static/icon/kimi.png" alt="Kimi" style="width: 20px; height: 20px; object-fit: cover; border-radius: 50%; margin-right: 8px;">';
                                modelName = 'Kimi';
                                break;
                            case 'gemini':
                                iconHtml = '<i class="bi bi-google" style="margin-right: 8px;"></i>';
                                modelName = 'Gemini';
                                break;
                            case 'minimax':
                                iconHtml = '<img src="/static/icon/Minimax.jpg" alt="MiniMax" style="width: 20px; height: 20px; object-fit: cover; border-radius: 50%; margin-right: 8px;">';
                                modelName = 'MiniMax';
                                break;
                            case 'qwen':
                                iconHtml = '<img src="/static/icon/qwen.jpg" alt="Qwen" style="width: 20px; height: 20px; object-fit: cover; border-radius: 50%; margin-right: 8px;">';
                                modelName = 'Qwen2.5-VL';
                                break;
                            case 'douban':
                                iconHtml = '<img src="/static/icon/doubao.jpg" alt="豆包" style="width: 20px; height: 20px; object-fit: cover; border-radius: 50%; margin-right: 8px;">';
                                modelName = '豆包';
                                break;
                            case 'llama_scout':
                                iconHtml = '<img src="/static/icon/yuanjing.jpeg" alt="元景" style="width: 20px; height: 20px; object-fit: cover; border-radius: 50%; margin-right: 8px;">';
                                modelName = '联通元景';
                                break;
                        }
                        
                        // 更新模型按钮显示
                        modelDropdown.innerHTML = `${iconHtml}${modelName}`;
                    }
                    
                    state.selectedModel = model;
                } catch (error) {
                    console.error('更新模型选择时出错:', error);
                }
            },

            showVideoPreview(file) {
                try {
                    this.cleanupVideoPreview();
                    
                    state.currentVideoURL = utils.createSafeBlobURL(file);
                    elements.videoPreview.src = state.currentVideoURL;
                    
                    elements.dropZone.classList.add('has-video');
                    elements.videoPreview.style.display = 'block'; // Explicitly set video to display
                    elements.uploadContent.style.display = 'none'; // Explicitly hide upload content
                    state.hasUploadedVideo = true;

                    elements.videoPreview.onloadeddata = () => {
                        elements.videoPreview.play().catch(error => {
                            console.warn('自动播放失败:', error);
                        });
                    };

                    elements.videoPreview.onerror = () => {
                        this.showAlert('error', '视频加载失败，请重试');
                        this.cleanupVideoPreview();
                    };
                } catch (error) {
                    console.error('显示视频预览时出错:', error);
                    this.showAlert('error', '视频预览失败，请重试');
                }
            },

            cleanupVideoPreview() {
                try {
                    if (elements.videoPreview) {
                        elements.videoPreview.pause();
                        elements.videoPreview.removeAttribute('src');
                        elements.videoPreview.style.display = 'none'; // Explicitly hide video
                        elements.videoPreview.load();
                    }
                    utils.clearVideoResource();
                } catch (error) {
                    console.error('清理视频预览时出错:', error);
                }
            },

            updateFrameIntervalDisplay(value, isStream = false) {
                const valueElement = isStream ? elements.localCameraFrameIntervalValue : elements.frameIntervalValue;
                const slider = isStream ? elements.localCameraFrameInterval : elements.frameInterval;
                
                valueElement.textContent = value;
                slider.value = value;
            }
        };

        // 文件处理控制器
        const fileController = {
            handleFile(file) {
                try {
                    if (state.isProcessing) {
                        uiController.showAlert('error', '正在处理中');
                        return;
                    }

                    if (!utils.isValidVideoType(file.type)) {
                        uiController.showAlert('error', '请上传有效的视频文件');
                        return;
                    }

                    if (!utils.isValidFileSize(file.size)) {
                        uiController.showAlert('error', `文件大小不能超过${utils.formatFileSize(CONFIG.maxFileSize)}`);
                        return;
                    }

                    state.isProcessing = true;
                    uiController.showVideoPreview(file);
                    state.videoName = file.name.replace(/\.[^/.]+$/, "");
                    this.initializeFrameExtraction(file);
                    state.isProcessing = false;
                } catch (error) {
                    console.error('处理文件时出错:', error);
                    uiController.showAlert('error', '处理文件时出错');
                    state.isProcessing = false;
                }
            },
            
            initializeFrameExtraction(file) {
                try {
                    const video = document.createElement('video');
                    video.src = utils.createSafeBlobURL(file);
                    
                    video.onloadedmetadata = () => {
                        // 在视频数据加载完成后计算总帧数
                        // 获取用户调整的帧间隔
                        const frameInterval = this.getFrameInterval();

                        // 修改总帧数计算方法，使用Math.floor来确保只在整数倍的时间点提取帧
                        const totalFrames = Math.floor(video.duration / frameInterval) + 1; // +1是因为要包括0秒的第一帧
                        
                        // 移除额外最后一帧的逻辑，确保严格按照间隔提取
                        state.frameCount = totalFrames;
                        state.streamExtractedFrames = [];
                        state.currentFrameIndex = 0;
                        
                        this.extractFrames(video, frameInterval, totalFrames, video.duration);
                    };
                    
                    video.onerror = () => {
                        console.error('视频加载失败，无法抽取帧');
                        uiController.showAlert('error', '视频加载失败');
                    };
                } catch (error) {
                    console.error('初始化帧抽取时出错:', error);
                    uiController.showAlert('error', '初始化帧抽取时出错');
                }
            },
            
            getFrameInterval() {
                // 确保使用用户在界面上设置的帧间隔值
                if (elements && elements.frameInterval) {
                return parseFloat(elements.frameInterval.value);
                }
                // 如果没有找到元素或值，使用默认值
                return CONFIG.defaultFrameInterval || 2.0;
            },
            
            extractFrames(video, interval, totalFrames, duration) {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // 初始帧索引和提取计数器
                    let currentIndex = 0;
                    
                    // 存储视频源以确保在整个过程中有效
                    const videoSrc = video.src;
                    
                    const extractFrame = (time) => {
                        // 确保不超过视频总长度
                        if (time >= duration) {

                            uiController.showAlert('info', `抽取完成`);
                            // 确保在最后释放资源
                            setTimeout(() => {
                                utils.revokeBlobURL(videoSrc);

                            }, 500);
                            return;
                        }

                        // 检查视频是否还在有效状态
                        if (video.readyState === 0) {
                            console.error('视频元素已失效，无法继续提取帧');
                            uiController.showAlert('error', '视频处理失败');
                            URL.revokeObjectURL(videoSrc);
                            return;
                        }

                        try {
                            video.currentTime = time;
                        } catch (e) {
                            console.error('设置视频时间失败:', e);
                            uiController.showAlert('error', '视频处理失败');
                            URL.revokeObjectURL(videoSrc);
                            return;
                        }
                        
                        video.onseeked = () => {
                            try {
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                
                                const frameDataUrl = canvas.toDataURL('image/jpeg', CONFIG.frameQuality);
                                
                                // 记录精确的当前时间点
                                const exactTime = video.currentTime;
                                console.log(`抽取帧 #${state.currentFrameIndex + 1}，时间点: ${exactTime.toFixed(2)}秒`);
                                
                                state.streamExtractedFrames.push({
                                    time: exactTime, // 使用精确的时间点
                                    dataUrl: frameDataUrl,
                                    data: frameDataUrl, // 同时添加data属性以保持一致性
                                    timestamp: new Date().getTime(), // 添加timestamp属性以与其他模块保持一致
                                    extracted: new Date().getTime() // 添加提取时间戳
                                });
                                
                                state.currentFrameIndex++;
                                currentIndex++;
                                
                                // 处理下一帧
                                if (currentIndex < totalFrames) {
                                    // 获取每次处理帧时的最新间隔值
                                    const currentInterval = this.getFrameInterval();
                                    
                                    // 下一帧的时间点，严格按照当前间隔增加
                                    const nextTime = currentIndex * currentInterval;
                                    
                                    // 检查是否超出视频长度
                                    if (nextTime < duration) {
                                        // 记录正在使用的间隔
                                        console.log(`继续抽帧，使用当前间隔: ${currentInterval}秒`);
                                        // 使用requestAnimationFrame而不是setTimeout以获得更好的性能
                                        requestAnimationFrame(() => setTimeout(() => extractFrame(nextTime), 50));
                                    } else {
                                        console.log(`画面抽取完成，共抽取${state.streamExtractedFrames.length}帧`);
                                        uiController.showAlert('info', `抽取完成`);
                                        setTimeout(() => utils.revokeBlobURL(videoSrc), 500);
                                    }
                                } else {
                                    console.log(`画面抽取完成，共抽取${state.streamExtractedFrames.length}帧`);
                                    uiController.showAlert('info', `抽取完成`);
                                    setTimeout(() => utils.revokeBlobURL(videoSrc), 500);
                                }
                            } catch (e) {
                                console.error('处理视频帧时出错:', e);
                                // 出错时也要释放资源
                                setTimeout(() => utils.revokeBlobURL(videoSrc), 500);
                            }
                        };
                    };
                    
                    // 从0秒开始提取第一帧
                    extractFrame(0);
                } catch (error) {
                    console.error('抽取帧时出错:', error);
                    uiController.showAlert('error', '抽取帧时出错');
                }
            }
        };

        // 视频流控制器
        const streamController = {
            async startStream() {
                try {
                    if (state.localCameraActive) return;
                    
                    state.isProcessing = true;
                    
                    // 请求摄像头访问权限
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });
                    
                    state.mediaStream = stream;
                    elements.localCameraVideo.srcObject = stream;
                    elements.localCameraContainer.classList.add('active');
                    
                    elements.localCameraVideo.onloadedmetadata = () => {
                        elements.localCameraVideo.play()
                            .then(() => {
                                state.localCameraActive = true;
                                state.isProcessing = false;
                                uiController.showAlert('info', '本地摄像头已连接'); // 更新消息
                            })
                            .catch(error => {
                                console.error('播放摄像头视频失败:', error);
                                this.stopStream();
                                uiController.showAlert('error', '无法启动摄像头');
                            });
                    };
                    
                    elements.localCameraVideo.onerror = (error) => {
                        console.error('摄像头视频错误:', error);
                        this.stopStream();
                        uiController.showAlert('error', '摄像头错误: ' + error);
                    };
                } catch (error) {
                    console.error('启动本地摄像头失败:', error); // 更新消息
                    state.isProcessing = false;
                    uiController.showAlert('error', '无法访问摄像头: ' + (error.message || '未授权'));
                }
            },

            stopStream() {
                try {
                    if (!state.localCameraActive) return;
                    
                    if (state.mediaStream) {
                        const tracks = state.mediaStream.getTracks();
                        tracks.forEach(track => track.stop());
                        console.log('本地摄像头已关闭'); // 更新消息
                    }
                    
                    if (elements.localCameraVideo) {
                        elements.localCameraVideo.srcObject = null;
                    }
                    
                    elements.localCameraContainer.classList.remove('active');
                    
                    state.mediaStream = null;
                    state.localCameraActive = false;
                } catch (error) {
                    console.error('停止本地摄像头时出错:', error); // 更新消息
                }
            },
            
            captureCurrentFrame() {
                try {
                    if (!state.localCameraActive || !elements.localCameraVideo) {
                        return null;
                    }
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = elements.localCameraVideo.videoWidth;
                    canvas.height = elements.localCameraVideo.videoHeight;
                    
                    ctx.drawImage(elements.localCameraVideo, 0, 0, canvas.width, canvas.height);
                    
                    return canvas.toDataURL('image/jpeg', 0.85);
                } catch (error) {
                    console.error('捕获本地摄像头帧时出错:', error); // 更新消息
                    return null;
                }
            }
        };

        // 模式切换控制器
        const modeController = {
            switchMode(mode) {
                try {
                    if (analysisController.isAnalyzing) {
                        analysisController.stopAnalysis();
                    }
                    
                    // 停止智能分析（如果正在进行）
                    if (typeof intelligentAnalysisController !== 'undefined' && 
                        intelligentAnalysisController.isAnalyzing) {
                        intelligentAnalysisController.stopIntelligentAnalysis();
                    }
                    
                    searchResultController.clearResults();
                    
                    if (mode === 'upload') {
                        this.switchToUploadMode();
                    } else if (mode === 'stream') {
                        this.switchToStreamMode();
                    } else if (mode === 'ipCamera') {
                        this.switchToIPCameraMode();
                    } else if (mode === 'image') {
                        this.switchToImageMode();
                    }
                    
                    state.currentMode = mode;
                } catch (error) {
                    console.error('切换模式时出错:', error);
                    uiController.showAlert('error', '切换模式时出错');
                }
            },

            switchToUploadMode() {
                elements.uploadBtn.className = 'btn btn-primary active';
                elements.localCameraBtn.className = 'btn btn-outline-primary';
                elements.ipCameraBtn.className = 'btn btn-outline-primary';
                elements.imageBtn.className = 'btn btn-outline-primary';
                
                elements.uploadSection.classList.add('active');
                elements.localCameraSection.classList.remove('active');
                elements.ipCameraSection.classList.remove('active');
                elements.imageSection.classList.remove('active');
                
                // 停止视频流（如果有）
                streamController.stopStream();
                state.hasUploadedVideo = false;
                
                // 重置上传区域
                if (state.currentVideoURL) {
                    elements.videoPreview.style.display = 'block';
                    elements.uploadContent.style.display = 'none';
                } else {
                    elements.videoPreview.style.display = 'none';
                    elements.uploadContent.style.display = 'flex';
                }
            },

            switchToStreamMode() {
                elements.uploadBtn.className = 'btn btn-outline-primary';
                elements.localCameraBtn.className = 'btn btn-primary active';
                elements.ipCameraBtn.className = 'btn btn-outline-primary';
                elements.imageBtn.className = 'btn btn-outline-primary';
                
                elements.uploadSection.classList.remove('active');
                elements.localCameraSection.classList.add('active');
                elements.ipCameraSection.classList.remove('active');
                elements.imageSection.classList.remove('active');
                
                // 停止之前的视频流（如果有）
                streamController.stopStream();
                state.hasUploadedVideo = false;
                
                // 启动视频流
                streamController.startStream();
            },
            
            switchToIPCameraMode() {
                elements.uploadBtn.className = 'btn btn-outline-primary';
                elements.localCameraBtn.className = 'btn btn-outline-primary';
                elements.ipCameraBtn.className = 'btn btn-primary active';
                elements.imageBtn.className = 'btn btn-outline-primary';
                
                elements.uploadSection.classList.remove('active');
                elements.localCameraSection.classList.remove('active');
                elements.ipCameraSection.classList.add('active');
                elements.imageSection.classList.remove('active');
                
                // 停止之前的视频流（如果有）
                streamController.stopStream();
                state.hasUploadedVideo = false;
                
                // 这里只显示UI，不实际启动摄像头
                uiController.showAlert('info', '请输入网络摄像头地址并点击连接按钮');
            },

            switchToImageMode() {
                elements.uploadBtn.className = 'btn btn-outline-primary';
                elements.localCameraBtn.className = 'btn btn-outline-primary';
                elements.ipCameraBtn.className = 'btn btn-outline-primary';
                elements.imageBtn.className = 'btn btn-primary active';
                
                elements.uploadSection.classList.remove('active');
                elements.localCameraSection.classList.remove('active');
                elements.ipCameraSection.classList.remove('active');
                elements.imageSection.classList.add('active');
                
                // 停止之前的视频流（如果有）
                streamController.stopStream();
                state.hasUploadedVideo = false;
                
                // 初始化图片上传区域
                imageController.init();
                
                uiController.showAlert('info', '请上传图片文件');
            }
        };

        // 图片控制器
        const imageController = {
            imageData: null,
            hasImage: false,
            
            init() {
                // 绑定图片处理事件
                this.bindEvents();
                
                // 重置状态
                this.resetState();
            },
            
            resetState() {
                this.imageData = null;
                this.hasImage = false;
                
                // 重置UI
                if (elements.imagePreview) {
                    elements.imagePreview.style.display = 'none';
                    elements.imagePreview.src = '';
                }
                
                if (elements.imageDropZone) {
                    elements.imageDropZone.classList.remove('has-image');
                }
                
                const uploadContent = elements.imageDropZone.querySelector('.upload-content');
                if (uploadContent) {
                    uploadContent.style.display = 'flex';
                }
                
                // 清除input值
                if (elements.imageInput) {
                    elements.imageInput.value = '';
                }
            },
            
            handleFile(file) {
                if (!file) return;
                
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    uiController.showAlert('error', '请上传图片文件（JPG、PNG、GIF）');
                    return;
                }
                
                // 检查文件大小
                if (file.size > 10 * 1024 * 1024) { // 10MB限制
                    uiController.showAlert('error', '图片文件过大，请上传小于10MB的图片');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        // 保存图片数据
                        this.imageData = e.target.result;
                        
                        // 显示图片预览
                        elements.imagePreview.src = this.imageData;
                        elements.imagePreview.style.display = 'block';
                        
                        // 隐藏上传提示
                        const uploadContent = elements.imageDropZone.querySelector('.upload-content');
                        if (uploadContent) {
                            uploadContent.style.display = 'none';
                        }
                        
                        elements.imageDropZone.classList.add('has-image');
                        this.hasImage = true;
                        
                        uiController.showAlert('success', '图片上传成功，可以开始分析');
                    } catch (error) {
                        console.error('处理图片时出错:', error);
                        uiController.showAlert('error', '处理图片时出错，请重试');
                        this.resetState();
                    }
                };
                
                reader.onerror = () => {
                    console.error('读取图片文件时出错');
                    uiController.showAlert('error', '读取图片文件时出错，请重试');
                    this.resetState();
                };
                
                // 读取文件
                reader.readAsDataURL(file);
            },
            
            // 获取当前图片的base64数据
            getImageData() {
                return this.imageData;
            },
            
            bindEvents() {
                // 拖放处理
                elements.imageDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!this.hasImage) {
                        elements.imageDropZone.style.borderColor = 'var(--primary-color)';
                        elements.imageDropZone.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                elements.imageDropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!this.hasImage) {
                        elements.imageDropZone.style.borderColor = '#ccc';
                        elements.imageDropZone.style.backgroundColor = 'white';
                    }
                });
                
                elements.imageDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!this.hasImage) {
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            this.handleFile(files[0]);
                        }
                    }
                });
                
                // 点击上传
                elements.imageDropZone.addEventListener('click', () => {
                    if (!this.hasImage) {
                        elements.imageInput.click();
                    }
                });
                
                // 文件选择
                elements.imageInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });
            }
        };
        
        // 事件处理器
        const eventHandlers = {
            handleDragOver: utils.throttle(function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!state.hasUploadedVideo && !state.isProcessing) {
                    elements.dropZone.style.borderColor = 'var(--primary-color)';
                    elements.dropZone.style.backgroundColor = '#f8f9fa';
                }
            }, 100),

            handleDragLeave: utils.throttle(function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!state.hasUploadedVideo && !state.isProcessing) {
                    elements.dropZone.style.borderColor = '#ccc';
                    elements.dropZone.style.backgroundColor = 'white';
                }
            }, 100),

            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!state.hasUploadedVideo && !state.isProcessing) {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileController.handleFile(files[0]);
                    }
                }
            },

            handleClick() {
                if (!state.hasUploadedVideo && !state.isProcessing) {
                    elements.fileInput.click();
                }
            },

            handleFileChange(e) {
                if (e.target.files.length > 0 && !state.isProcessing) {
                    fileController.handleFile(e.target.files[0]);
                }
            },

            bindEvents() {
                try {
                    elements.dropZone.addEventListener('dragover', this.handleDragOver);
                    elements.dropZone.addEventListener('dragleave', this.handleDragLeave);
                    elements.dropZone.addEventListener('drop', this.handleDrop);
                    elements.dropZone.addEventListener('click', this.handleClick);
                    elements.fileInput.addEventListener('change', this.handleFileChange);

                    elements.frameInterval.addEventListener('input', utils.debounce(() => {
                        uiController.updateFrameIntervalDisplay(elements.frameInterval.value);
                    }, 100));
                    
                    elements.localCameraFrameInterval.addEventListener('input', utils.debounce(() => {
                        uiController.updateFrameIntervalDisplay(elements.localCameraFrameInterval.value, true);
                    }, 100));
                    
                    elements.localCameraVideo.addEventListener('error', (error) => {
                        console.error('本地摄像头错误:', error);
                        uiController.showAlert('error', '本地摄像头错误，请刷新页面重试');
                    });

                    window.addEventListener('beforeunload', () => {
                        utils.clearTimeouts();
                        if (analysisController.isAnalyzing) {
                            analysisController.stopAnalysis();
                        }
                        streamController.stopStream();
                        ipCameraController.disconnectCamera();
                        uiController.cleanupVideoPreview();
                    });
                } catch (error) {
                    console.error('绑定事件时出错:', error);
                }
            }
        };

        // 搜索目标控制器
        const searchTargetController = {
            showMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `alert-message ${type}`;
                messageDiv.innerHTML = `
                    <i class="bi bi-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                    ${content}
                `;
                
                const container = elements.searchTargetsContainer;
                container.insertBefore(messageDiv, elements.searchTargetsList);
                
                messageDiv.classList.add('show');
                setTimeout(() => {
                    messageDiv.classList.remove('show');
                    setTimeout(() => messageDiv.remove(), 300);
                }, 3000);
            },

            addTarget(content) {
                try {
                    const trimmedContent = content.trim();
                    if (!trimmedContent) {
                        this.showMessage('error', '请输入有效的搜索目标描述');
                        return;
                    }
                    
                    if (state.searchTargets.includes(trimmedContent)) {
                        this.showMessage('error', '该搜索目标已存在');
                        return;
                    }
                    
                    state.searchTargets.push(trimmedContent);
                    this.renderTargets();
                    this.showMessage('success', '已添加搜索目标');
                    elements.targetInput.value = '';
                    this.saveToStorage();
                } catch (error) {
                    console.error('添加搜索目标时出错:', error);
                    this.showMessage('error', '添加目标时出错，请重试');
                }
            },

            removeTarget(index) {
                try {
                    state.searchTargets.splice(index, 1);
                    this.renderTargets();
                    this.saveToStorage();
                    this.showMessage('success', '已删除搜索目标');
                } catch (error) {
                    console.error('删除搜索目标时出错:', error);
                    this.showMessage('error', '删除目标时出错，请重试');
                }
            },

            renderTargets() {
                try {
                    elements.searchTargetsList.innerHTML = state.searchTargets
                        .map((target, index) => `
                            <div class="search-target-item">
                                <div class="search-target-content">
                                    ${target}
                                    <button class="btn btn-outline-danger btn-sm ms-2" 
                                            onclick="searchTargetController.removeTarget(${index})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `)
                        .join('');
                } catch (error) {
                    console.error('渲染搜索目标列表时出错:', error);
                }
            },

            saveToStorage() {
                try {
                    localStorage.setItem('searchTargets', JSON.stringify(state.searchTargets));
                } catch (error) {
                    console.error('保存搜索目标到本地存储时出错:', error);
                }
            },

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('searchTargets');
                    if (saved) {
                        state.searchTargets = JSON.parse(saved);
                        this.renderTargets();
                    }
                } catch (error) {
                    console.error('从本地存储加载搜索目标时出错:', error);
                }
            },

            bindEvents() {
                try {
                    elements.targetInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.addTarget(elements.targetInput.value);
                        }
                    });

                    elements.addTargetBtn.addEventListener('click', () => {
                        this.addTarget(elements.targetInput.value);
                    });
                    
                    elements.analyzeBtn.addEventListener('click', () => {
                        analysisController.startAnalysis();
                    });
                    
                    elements.stopAnalyzeBtn.addEventListener('click', () => {
                        analysisController.stopAnalysis();
                    });
                } catch (error) {
                    console.error('绑定搜索目标事件时出错:', error);
                }
            }
        };

        // 搜索结果控制器
        const searchResultController = {
            addResult(result) {
                try {
                    // 添加结果到数组
                    state.searchResults.push(result);
                    state.resultCount++;
                    
                    // 对结果排序 - 按照视频时间或帧号排序
                    this.sortResults();
                    
                    // 更新UI显示
                    this.renderResults();
                    this.updateResultCount();
                    
                    // 限制结果数量，防止内存占用过大
                    if (state.searchResults.length > CONFIG.maxResultsCount) {
                        state.searchResults = state.searchResults.slice(0, CONFIG.maxResultsCount);
                    }
                } catch (error) {
                    console.error('添加搜索结果时出错:', error);
                }
            },
            
            // 对结果进行排序
            sortResults() {
                try {
                    // 选择排序依据：如果有视频时间则按时间排序，否则按帧号排序
                    if (state.hasUploadedVideo) {
                        // 视频模式：按时间点排序（降序，最新的在前面）
                        state.searchResults.sort((a, b) => {
                            // 使用视频时间点作为主要排序依据
                            if (a.videoTime !== undefined && b.videoTime !== undefined) {
                                return b.videoTime - a.videoTime;
                            }
                            // 回退到帧号排序
                            return b.frameNumber - a.frameNumber;
                        });
                    } else {
                        // 实时流模式：按帧号排序（降序，最新的在前面）
                        state.searchResults.sort((a, b) => b.frameNumber - a.frameNumber);
                    }
                } catch (error) {
                    console.error('排序结果时出错:', error);
                }
            },

            renderResults() {
                try {
                    if (state.searchResults.length === 0) {
                        elements.noResultsMessage.style.display = 'flex';
                        elements.searchResultsList.innerHTML = '';
                        return;
                    }

                    elements.noResultsMessage.style.display = 'none';
                    elements.searchResultsList.innerHTML = state.searchResults
                        .map(result => this.createResultItemHTML(result))
                        .join('');
                } catch (error) {
                    console.error('渲染搜索结果时出错:', error);
                }
            },

            createResultItemHTML(result) {
                try {
                    const timeDisplay = state.hasUploadedVideo ? 
                        utils.formatTime(result.videoTime) : 
                        new Date(result.timestamp).toLocaleTimeString();

                    // 检查targets是否有效，并确保每个目标都有found属性
                    const validTargets = Array.isArray(result.targets) ? result.targets : [];
                    
                    // 记录原始响应，用于调试
                    console.log("API返回原始结果对象:", result);
                    // 仅用于人类查看的JSON格式
                    console.log("API返回序列化JSON:", JSON.stringify(result, null, 2));

                    // 添加处理不同类型found值的逻辑 - 增强版
                    const processedTargets = validTargets.map(target => {
                        if (!target) return null;
                        
                        // 创建新对象避免修改原始数据
                        const processed = { ...target };
                        const originalValue = target.found;
                        const originalType = typeof originalValue;
                        
                        // 更详细地记录原始值信息
                        console.log(`目标 "${target.name}" 原始found值: ${originalValue} (${originalType}), JSON序列化: ${JSON.stringify(originalValue)}`);
                        
                        // 强制转换为布尔值 - 使用严格比较
                        let boolValue;
                        if (originalType === 'boolean') {
                            // 已经是布尔值
                            boolValue = originalValue === true;
                        } else if (originalValue === 'True' || originalValue === 'true' || originalValue === 1 || originalValue === '1') {
                            // 处理字符串"True"或数字1
                            boolValue = true;
                        } else if (originalValue === 'False' || originalValue === 'false' || originalValue === 0 || originalValue === '0' || originalValue === null || originalValue === undefined) {
                            // 处理字符串"False"、数字0或null/undefined
                            boolValue = false;
                        } else {
                            // 其他值，使用严格的显式转换，默认为false
                            console.warn(`目标 "${target.name}" 有不明确的found值: ${originalValue}，默认设置为false`);
                            boolValue = false;
                        }
                        
                        // 显式删除原有的found和isFound属性，以避免属性访问问题
                        delete processed.found;
                        delete processed.isFound;
                        
                        // 重新添加found和isFound属性
                        Object.defineProperties(processed, {
                            'found': {
                                value: boolValue,
                                writable: true,
                                enumerable: true,
                                configurable: true
                            },
                            'isFound': {
                                value: boolValue,
                                writable: true,
                                enumerable: true,
                                configurable: true
                            }
                        });
                        
                        // 记录转换后的值
                        console.log(`目标 "${target.name}" 处理后found值: ${boolValue} (${typeof boolValue})`);
                        
                        return processed;
                    }).filter(t => t !== null);
                    
                    // 分类为找到和未找到的目标
                    const foundTargets = processedTargets.filter(t => t.found === true);
                    const notFoundTargets = processedTargets.filter(t => t.found === false);
                    
                    // 输出分类结果
                    console.log(`✅ 找到的目标 (${foundTargets.length}):`, 
                        foundTargets.map(t => t.name).join(", ") || "无");
                    console.log(`❌ 未找到的目标 (${notFoundTargets.length}):`, 
                        notFoundTargets.map(t => t.name).join(", ") || "无");
                    
                    // 检查是否有目标未被正确分类
                    const totalClassified = foundTargets.length + notFoundTargets.length;
                    if (totalClassified !== processedTargets.length) {
                        console.warn(
                            "警告: 部分目标未被正确分类! 总数:", processedTargets.length, 
                            "找到:", foundTargets.length, 
                            "未找到:", notFoundTargets.length,
                            "未分类:", processedTargets.length - totalClassified
                        );
                    }

                    // 在渲染前记录每个目标的状态 - 帮助调试
                    processedTargets.forEach(target => {
                        console.log(`渲染前目标 "${target.name}" found值: ${target.found} (${typeof target.found})`);
                    });
                    
                    return `
                        <div class="result-item">
                            <div class="result-header">
                                <span class="result-timestamp">${timeDisplay}</span>
                                <span class="result-frame-number">帧 #${result.frameNumber}</span>
                            </div>
                            <div class="result-content">
                                <div class="result-frame">
                                    <img src="${result.frameImage}" alt="Frame ${result.frameNumber}">
                                </div>
                                <div class="result-info">
                                    <div class="result-description">${result.description}</div>
                                    <div class="result-targets">
                                        ${processedTargets.map(target => {
                                            // 直接检查布尔值，避免使用可能有问题的对象属性访问
                                            const isFound = target.found === true;
                                            console.log(`渲染目标: ${target.name}, found=${target.found}, isFound=${isFound}`);
                                            
                                            return isFound ? 
                                            `<span class="target-tag found">
                                                <i class="bi bi-check-circle"></i>
                                                ${target.name}
                                            </span>` : 
                                            `<span class="target-tag not-found">
                                                <i class="bi bi-x-circle"></i>
                                                ${target.name}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error("创建结果项HTML时出错:", error);
                    return `
                        <div class="result-item">
                            <div class="result-header">
                                <span class="result-timestamp">错误</span>
                                <span class="result-frame-number">帧 #${result.frameNumber || 'N/A'}</span>
                            </div>
                            <div class="result-content">
                                <div class="result-info">
                                    <div class="result-description">
                                        显示结果时出错: ${error.message || '未知错误'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            updateResultCount() {
                elements.resultCount.textContent = state.resultCount.toString();
            },

            clearResults() {
                state.searchResults = [];
                state.resultCount = 0;
                this.renderResults();
                this.updateResultCount();
            }
        };

        // 图像预处理控制器
        const imagePreprocessor = {
            // 压缩图像
            compressImage(dataUrl, maxWidth = 800, maxHeight = 600, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    try {
                        const img = new Image();
                        img.onload = () => {
                            // 计算压缩后的尺寸
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                            
                            if (height > maxHeight) {
                                width = Math.round((width * maxHeight) / height);
                                height = maxHeight;
                            }
                            
                            // 创建canvas进行压缩
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // 转换为压缩后的dataUrl
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(compressedDataUrl);
                        };
                        
                        img.onerror = () => {
                            reject(new Error('图像加载失败'));
                        };
                        
                        img.src = dataUrl;
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            // 增强对比度
            enhanceContrast(dataUrl, contrast = 1.2, brightness = 1.1) {
                return new Promise((resolve, reject) => {
                    try {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            
                            const ctx = canvas.getContext('2d');
                            
                            // 绘制原始图像
                            ctx.drawImage(img, 0, 0);
                            
                            // 获取图像数据
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            
                            // 应用对比度和亮度调整
                            for (let i = 0; i < data.length; i += 4) {
                                // 对比度调整
                                data[i] = ((data[i] - 128) * contrast + 128) * brightness;
                                data[i + 1] = ((data[i + 1] - 128) * contrast + 128) * brightness;
                                data[i + 2] = ((data[i + 2] - 128) * contrast + 128) * brightness;
                                
                                // 确保值在有效范围内
                                data[i] = Math.min(255, Math.max(0, data[i]));
                                data[i + 1] = Math.min(255, Math.max(0, data[i + 1]));
                                data[i + 2] = Math.min(255, Math.max(0, data[i + 2]));
                            }
                            
                            // 将处理后的数据放回canvas
                            ctx.putImageData(imageData, 0, 0);
                            
                            // 转换为dataUrl
                            const enhancedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                            resolve(enhancedDataUrl);
                        };
                        
                        img.onerror = () => {
                            reject(new Error('图像加载失败'));
                        };
                        
                        img.src = dataUrl;
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            // 预处理图像（压缩并增强对比度）
            async preprocessImage(dataUrl) {
                try {
                    // 先压缩图像
                    const compressedImage = await this.compressImage(dataUrl);
                    // 再增强对比度
                    const enhancedImage = await this.enhanceContrast(compressedImage);
                    return enhancedImage;
                } catch (error) {
                    console.error('图像预处理失败:', error);
                    return dataUrl; // 如果处理失败，返回原始图像
                }
            }
        };

        // 分析控制器
        const analysisController = {
            isAnalyzing: false,
            currentFrameIndex: 0,
            lastAnalysisTime: 0,
            processingQueue: [],
            localCameraFrameBuffer: [], // 原 streamFrameBuffer
            
            async startAnalysis() {
                try {
                    if (this.isAnalyzing) {
                        uiController.showAlert('error', '分析正在进行中');
                        return;
                    }
                    
                    if (state.searchTargets.length === 0) {
                        uiController.showAlert('error', '请先添加搜索目标');
                        return;
                    }
                    
                    // 修改这里，添加图片模式支持
                    if (!state.hasUploadedVideo && !state.localCameraActive && !state.ipCameraActive && 
                        !(state.currentMode === 'image' && imageController.hasImage)) {
                        uiController.showAlert('error', '请先上传视频、图片、启动本地摄像头或连接网络摄像头');
                        return;
                    }
                    
                    if (state.hasUploadedVideo && (!state.streamExtractedFrames || state.streamExtractedFrames.length === 0)) {
                        uiController.showAlert('error', '视频帧抽取未完成');
                        return;
                    }
                    
                    this.isAnalyzing = true;
                    this.currentFrameIndex = 0;
                    this.lastAnalysisTime = 0;
                    this.processingQueue = [];
                    this.localCameraFrameBuffer = [];
                    
                    elements.analyzeBtn.disabled = true;
                    elements.analyzeBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 分析中...';
                    elements.stopAnalyzeBtn.style.display = 'inline-block'; // 显示停止按钮
                    
                    searchResultController.clearResults();
                    
                    if (state.hasUploadedVideo) {
                        const frameCount = state.streamExtractedFrames.length;
                        uiController.showAlert('info', `开始分析 ${frameCount}帧`);
                        await this.startBatchProcessing();
                    } else if (state.localCameraActive) {
                        uiController.showAlert('info', '开始本地摄像头分析');
                        await this.analyzeLocalCameraFrame();
                    } else if (state.ipCameraActive) {
                        uiController.showAlert('info', '开始网络摄像头分析');
                        // 检查ipCameraController是否可用并有startAnalysis方法
                        if (typeof window.ipCameraController !== 'undefined' && 
                            typeof window.ipCameraController.startAnalysis === 'function') {
                            // 使用ipCameraController中的分析方法开始分析
                            window.ipCameraController.startAnalysis(this.callModelAPI.bind(this));
                        } else {
                            // 使用内部方法作为备选
                            await this.startIpCameraAnalysis();
                        }
                    } else if (state.currentMode === 'image' && imageController.hasImage) {
                        uiController.showAlert('info', '开始图片分析');
                        await this.analyzeImageData();
                    }
                    
                } catch (error) {
                    console.error('启动分析时出错:', error);
                    uiController.showAlert('error', '启动分析时出错: ' + error.message);
                    this.stopAnalysis();
                }
            },
            
            // 批量处理帧
            async startBatchProcessing() {
                try {
                    // 批量大小和总帧数
                    const batchSize = 3; // 一次处理3帧
                    const totalFrames = state.streamExtractedFrames.length;
                    
                    // 每个批次的进度消息间隔
                    const progressInterval = Math.max(1, Math.floor(totalFrames / 10));
                    
                    // 记录所有处理结果
                    const allResults = [];
                    
                    // 循环处理批次
                    for (let i = 0; i < totalFrames && this.isAnalyzing; i += batchSize) {
                        // 显示进度
                        if (i % progressInterval === 0 || i + batchSize >= totalFrames) {
                            uiController.showAlert('info', `正在分析: ${Math.min(i + batchSize, totalFrames)}/${totalFrames} 帧`);
                        }
                        
                        // 创建当前批次的处理承诺
                        const batchPromises = [];
                        
                        // 为每一帧创建处理任务
                        for (let j = 0; j < batchSize && i + j < totalFrames; j++) {
                            this.currentFrameIndex = i + j;
                            batchPromises.push(this.processFrame(this.currentFrameIndex));
                        }
                        
                        // 等待当前批次完成
                        await Promise.all(batchPromises);
                        
                        // 短暂暂停以避免API限制
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    // 完成后确保结果按正确顺序显示
                    searchResultController.sortResults();
                    searchResultController.renderResults();
                    
                    if (this.isAnalyzing) {
                        console.log("所有帧分析完成");
                        // 直接使用total frames作为帧数，确保显示正确的帧数
                        const totalFrames = state.streamExtractedFrames.length;
                        uiController.showAlert('info', `分析完成 ${totalFrames}帧`);
                        this.stopAnalysis(false); // 传入false参数表示不再显示分析完成信息
                    }
                } catch (error) {
                    console.error("批处理过程中出错:", error);
                    uiController.showAlert('error', "批处理错误: " + error.message);
                    this.stopAnalysis();
                }
            },
            
            // 处理单个帧
            async processFrame(frameIndex) {
                try {
                    // 获取帧图像
                    const frameImage = state.streamExtractedFrames[frameIndex].dataUrl;
                    if (!frameImage) {
                        console.warn(`帧 #${frameIndex + 1} 图像数据无效`);
                        return;
                    }
                    
                    // 预处理图像
                    const processedImage = await imagePreprocessor.preprocessImage(frameImage);
                    
                    // 调用模型API
                    const analysisResult = await this.callModelAPI(processedImage, state.searchTargets);
                    
                    // 添加结果
                    searchResultController.addResult({
                        timestamp: Date.now(),
                        frameNumber: frameIndex + 1,
                        frameImage: processedImage,
                        description: analysisResult.description,
                        targets: analysisResult.targets,
                        videoTime: state.streamExtractedFrames[frameIndex].time
                    });
                    
                    return analysisResult;
                } catch (error) {
                    console.error(`处理帧 #${frameIndex + 1} 时出错:`, error);
                    throw error;
                }
            },
            
            async analyzeLocalCameraFrame() { // 原 analyzeStreamFrame
                try {
                    if (!this.isAnalyzing) return;
                    
                    // 创建帧收集缓冲区
                    if (!this.localCameraFrameBuffer) { // 更新变量名
                        this.localCameraFrameBuffer = []; // 更新变量名
                    }
                    
                    // 获取当前流视频帧
                    const frameImage = streamController.captureCurrentFrame();
                    if (!frameImage) {
                        console.log("未能捕获本地摄像头帧，将在500ms后重试"); // 更新消息
                        setTimeout(() => this.analyzeLocalCameraFrame(), 500);
                        return;
                    }

                    // 当前时间与上次分析时间的差值
                    const timeSinceLastAnalysis = Date.now() - this.lastAnalysisTime;
                    const frameInterval = 1000; // 固定为1秒间隔
                    
                    // 如果距离上次分析的时间不足帧间隔，则跳过当前帧
                    if (this.lastAnalysisTime > 0 && timeSinceLastAnalysis < frameInterval) {
                        // 计算下次分析前需要等待的时间
                        const waitTime = Math.max(50, frameInterval - timeSinceLastAnalysis);
                        setTimeout(() => this.analyzeLocalCameraFrame(), waitTime);
                        return;
                    }
                    
                    // 预处理图像
                    const processedImage = await imagePreprocessor.preprocessImage(frameImage);
                    
                    // 将当前帧添加到缓冲区
                    this.localCameraFrameBuffer.push({
                        timestamp: Date.now(),
                        frameNumber: this.currentFrameIndex + 1,
                        image: processedImage
                    });
                    
                    this.currentFrameIndex++;
                    this.lastAnalysisTime = Date.now();
                    
                    // 当收集到3帧或实时流分析停止时处理缓冲区
                    if (this.localCameraFrameBuffer.length >= 3 || !this.isAnalyzing) {
                        await this.processBatchLocalCameraFrames();
                    }
                    
                    // 继续收集下一帧
                    setTimeout(() => this.analyzeLocalCameraFrame(), 100);
                    
                } catch (error) {
                    console.error('分析流帧时出错:', error);
                    uiController.showAlert('error', '分析视频流时出错: ' + error.message);
                    this.stopAnalysis();
                }
            },
            
            // 批量处理流帧
            async processBatchLocalCameraFrames() {
                try {
                    if (this.localCameraFrameBuffer.length === 0) return;
                    
                    uiController.showAlert('info', `正在分析: ${this.localCameraFrameBuffer.length}帧`);
                    
                    // 创建批处理任务
                    const batchPromises = this.localCameraFrameBuffer.map(async (frameData) => {
                        // 分析每一帧
                        const analysisResult = await this.callModelAPI(frameData.image, state.searchTargets);
                        
                        // 将结果添加到搜索结果中
                        if (analysisResult.targets && analysisResult.targets.length > 0) {
                        searchResultController.addResult({
                            timestamp: frameData.timestamp,
                            frameNumber: frameData.frameNumber,
                            frameImage: frameData.image,
                            description: analysisResult.description,
                            targets: analysisResult.targets,
                                videoTime: null // 实时本地摄像头没有时间戳 // 更新注释
                        });
                        }
                        
                        return analysisResult;
                    });
                    
                    // 并行处理所有帧
                    await Promise.all(batchPromises);
                    
                    // 确保结果按照逆序显示
                    searchResultController.sortResults();
                    searchResultController.renderResults();
                    
                    // 清空缓冲区
                    this.localCameraFrameBuffer = [];
                    
                } catch (error) {
                    console.error('批量处理流帧时出错:', error);
                    this.localCameraFrameBuffer = []; // 出错时也清空缓冲区
                }
            },
            
            // 网络摄像头分析实现
            async startIpCameraAnalysis() {
                try {
                    if (!this.isAnalyzing) return;
                    
                    // 创建帧收集缓冲区
                    if (!this.ipCameraFrameBuffer) {
                        this.ipCameraFrameBuffer = [];
                    }
                    
                    // 获取当前网络摄像头帧
                    let frameImage = null;
                    
                    if (typeof streamController.captureIpCameraFrame === 'function') {
                        // 如果streamController有专门的函数
                        frameImage = streamController.captureIpCameraFrame();
                    } else {
                        // 否则尝试获取网络摄像头帧
                        const img = document.getElementById('ipCameraStream');
                        if (img && img.complete && img.naturalWidth > 0) {
                            // 使用canvas捕获当前图像
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            frameImage = canvas.toDataURL('image/jpeg', 0.85);
                        }
                    }
                    
                    if (!frameImage) {
                        console.log("未能捕获网络摄像头帧，将在500ms后重试");
                        // 如果仍在分析中，则稍后重试
                        if (this.isAnalyzing) {
                            setTimeout(() => this.startIpCameraAnalysis(), 500);
                        }
                        return;
                    }
                    
                    // 当前时间与上次分析时间的差值
                    const timeSinceLastAnalysis = Date.now() - this.lastAnalysisTime;
                    const frameInterval = 1000; // 固定为1秒间隔
                    
                    // 如果距离上次分析的时间不足帧间隔，则跳过当前帧
                    if (this.lastAnalysisTime > 0 && timeSinceLastAnalysis < frameInterval) {
                        // 计算下次分析前需要等待的时间
                        const waitTime = Math.max(50, frameInterval - timeSinceLastAnalysis);
                        if (this.isAnalyzing) {
                            setTimeout(() => this.startIpCameraAnalysis(), waitTime);
                        }
                        return;
                    }
                    
                    // 预处理图像
                    const processedImage = await imagePreprocessor.preprocessImage(frameImage);
                    
                    // 将当前帧添加到缓冲区
                    this.ipCameraFrameBuffer.push({
                        timestamp: Date.now(),
                        frameNumber: this.currentFrameIndex + 1,
                        image: processedImage
                    });
                    
                    this.currentFrameIndex++;
                    this.lastAnalysisTime = Date.now();
                    
                    // 当收集到3帧或网络摄像头分析停止时处理缓冲区
                    if (this.ipCameraFrameBuffer.length >= 3 || !this.isAnalyzing) {
                        await this.processBatchIpCameraFrames();
                    }
                    
                    // 继续收集下一帧
                    if (this.isAnalyzing) {
                        setTimeout(() => this.startIpCameraAnalysis(), 100);
                    }
                    
                } catch (error) {
                    console.error('分析网络摄像头帧时出错:', error);
                    uiController.showAlert('error', '分析网络摄像头时出错: ' + error.message);
                    this.stopAnalysis();
                }
            },
            
            // 批量处理网络摄像头帧
            async processBatchIpCameraFrames() {
                try {
                    if (!this.ipCameraFrameBuffer || this.ipCameraFrameBuffer.length === 0) return;
                    
                    uiController.showAlert('info', `正在分析: ${this.ipCameraFrameBuffer.length}帧`);
                    
                    // 创建批处理任务
                    const batchPromises = this.ipCameraFrameBuffer.map(async (frameData) => {
                        // 分析每一帧
                        const analysisResult = await this.callModelAPI(frameData.image, state.searchTargets);
                        
                        // 将结果添加到搜索结果中
                        if (analysisResult.targets && analysisResult.targets.length > 0) {
                            searchResultController.addResult({
                                timestamp: frameData.timestamp,
                                frameNumber: frameData.frameNumber,
                                frameImage: frameData.image,
                                description: analysisResult.description,
                                targets: analysisResult.targets,
                                videoTime: null // 网络摄像头没有时间戳
                            });
                        }
                        
                        return analysisResult;
                    });
                    
                    // 并行处理所有帧
                    await Promise.all(batchPromises);
                    
                    // 确保结果按照逆序显示
                    searchResultController.sortResults();
                    searchResultController.renderResults();
                    
                    // 清空缓冲区
                    this.ipCameraFrameBuffer = [];
                    
                } catch (error) {
                    console.error('批量处理网络摄像头帧时出错:', error);
                    this.ipCameraFrameBuffer = []; // 出错时也清空缓冲区
                }
            },
            
            async captureFrame() {
                try {
                    if (state.hasUploadedVideo) {
                        if (state.streamExtractedFrames && this.currentFrameIndex < state.streamExtractedFrames.length) {
                            return state.streamExtractedFrames[this.currentFrameIndex].dataUrl;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('捕获帧时出错:', error);
                    return null;
                }
            },
            
            async callModelAPI(frameImage, searchTargets) {
                try {
                    const result = await ModelAPIService.analyzeImage(state.selectedModel, frameImage, searchTargets);
                    
                    // 验证API返回结果的格式
                    if (!result || typeof result !== 'object') {
                        throw new Error('API返回结果格式无效');
                    }
                    
                    // 确保返回了描述
                    if (!result.description) {
                        console.warn("API没有返回描述内容");
                        result.description = "无法获取分析描述";
                    }
                    
                    // 确保targets数组是有效的
                    if (!result.targets || !Array.isArray(result.targets)) {
                        console.warn("API返回的targets不是数组，使用默认值");
                        result.targets = searchTargets.map(target => ({
                            name: target,
                            found: false
                        }));
                    }
                    
                    return result;
                } catch (error) {
                    console.error('调用模型API时出错:', error);
                    
                    // 返回一个默认的错误结果
                    return {
                        description: `分析出错: ${error.message || '未知错误'}`,
                        targets: searchTargets.map(target => ({
                            name: target,
                            found: false
                        }))
                    };
                }
            },
            
            // 分析单张图片数据
            async analyzeImageData() {
                try {
                    if (!imageController.hasImage) {
                        uiController.showAlert('error', '没有有效的图片数据');
                        this.stopAnalysis();
                        return;
                    }
                    
                    // 从imageController获取图片数据
                    const imageData = imageController.getImageData();
                    if (!imageData) {
                        uiController.showAlert('error', '无法获取图片数据');
                        this.stopAnalysis();
                        return;
                    }
                    
                    // 预处理图像
                    const processedImage = await imagePreprocessor.preprocessImage(imageData);
                    
                    // 调用模型API进行分析
                    const analysisResult = await this.callModelAPI(processedImage, state.searchTargets);
                    
                    // 添加分析结果
                    searchResultController.addResult({
                        timestamp: Date.now(),
                        frameNumber: 1, // 单张图片只有一帧
                        frameImage: processedImage,
                        description: analysisResult.description,
                        targets: analysisResult.targets,
                        videoTime: null // 图片没有时间戳
                    });
                    
                    // 更新结果显示
                    searchResultController.sortResults();
                    searchResultController.renderResults();
                    
                    // 完成分析
                    uiController.showAlert('success', '图片分析完成');
                    this.stopAnalysis(false);
                    
                } catch (error) {
                    console.error('分析图片数据时出错:', error);
                    uiController.showAlert('error', '分析图片时出错: ' + error.message);
                    this.stopAnalysis();
                }
            },
            
            stopAnalysis(showCompletionMessage = true) {
                this.isAnalyzing = false;
                this.processingQueue = [];
                
                // 处理剩余的流帧缓冲区
                if (this.localCameraFrameBuffer && this.localCameraFrameBuffer.length > 0) {
                    this.processBatchLocalCameraFrames();
                }
                
                // 停止网络摄像头分析
                if (state.ipCameraActive && ipCameraController && ipCameraController.analysisActive) {
                    ipCameraController.stopAnalysis();
                }
                
                elements.analyzeBtn.disabled = false;
                elements.analyzeBtn.innerHTML = '<i class="bi bi-play-fill"></i> 开始分析';
                elements.stopAnalyzeBtn.style.display = 'none'; // 隐藏停止按钮
                
                // 只有当showCompletionMessage为true时才显示分析完成信息
                if (showCompletionMessage && this.currentFrameIndex > 0) {
                    if (state.hasUploadedVideo) {
                        // 修正帧计数：currentFrameIndex是从0开始的索引，实际帧数为索引+1
                        uiController.showAlert('info', `分析完成 ${this.currentFrameIndex + 1}帧`);
                    } else if (state.localCameraActive) { // 本地摄像头
                        uiController.showAlert('info', '实时视频分析已停止');
                    } else if (state.ipCameraActive) { // 网络摄像头
                        uiController.showAlert('info', '网络摄像头分析已停止');
                    } else if (state.currentMode === 'image') { // 图片分析
                        uiController.showAlert('info', '图片分析已完成');
                    }
                }
            }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            try {
                elements.init();
                uiController.updateModelSelection(CONFIG.defaultModel);
                modeController.switchMode('upload');
                eventHandlers.bindEvents();
                searchTargetController.loadFromStorage();
                searchTargetController.bindEvents();
                searchTargetController.renderTargets(); // Add this line to render targets on page load
                searchResultController.renderResults();
                
                // 绑定网络摄像头连接按钮事件
                if (elements.connectCameraBtn) {
                    elements.connectCameraBtn.addEventListener('click', () => {
                        // 如果当前已连接，则断开连接
                        if (state.ipCameraActive) {
                            // 设置标记表示这是手动断开
                            state.manualDisconnect = true;
                            ipCameraController.disconnectCamera();
                            return;
                        }
                        
                        const rtspUrl = elements.ipCameraInput.value.trim();
                        if (!rtspUrl) {
                            uiController.showAlert('error', '请输入RTSP地址');
                            return;
                        }
                        
                        // 保存RTSP地址到本地存储
                        saveRtspUrl(rtspUrl);
                        
                        // 连接到RTSP流
                        ipCameraController.connectToCamera(rtspUrl);
                    });
                }
                
                // 加载上次使用的RTSP地址
                loadSavedRtspUrl();
                
                // 启动内存管理器
                utils.setupMemoryManager();
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.warn('浏览器不支持getUserMedia API，本地摄像头功能可能无法使用'); // 更新消息
                    elements.localCameraBtn.disabled = true;
                    elements.localCameraBtn.title = '您的浏览器不支持本地摄像头功能'; // 更新提示
                }
                
                // 添加页面卸载时的清理
                window.addEventListener('beforeunload', () => {
                    utils.clearTimeouts();
                    if (analysisController.isAnalyzing) {
                        analysisController.stopAnalysis();
                    }
                    streamController.stopStream();
                    ipCameraController.disconnectCamera();
                    uiController.cleanupVideoPreview();
                });
                
                console.log('应用初始化完成');
            } catch (error) {
                console.error('初始化时出错:', error);
            }
        });

        // 暴露给HTML的方法
        function selectModel(model) {
            if (!state.isProcessing) {
                // 如果正在分析，先停止分析
                if (analysisController.isAnalyzing) {
                    analysisController.stopAnalysis();
                    uiController.showAlert('info', '已停止分析并切换模型');
                }
                // 停止智能分析
                if (typeof intelligentAnalysisController !== 'undefined' && intelligentAnalysisController.isAnalyzing) {
                    intelligentAnalysisController.stopIntelligentAnalysis();
                    uiController.showAlert('info', '已停止智能分析并切换模型');
                }
                // 清空目标搜索结果
                if (typeof searchResultController !== 'undefined') {
                    searchResultController.clearResults();
                }
                // 清空智能分析结果
                if (typeof intelligentAnalysisController !== 'undefined') {
                    intelligentAnalysisController.clearIntelligentAnalysisHistory();
                }
                uiController.updateModelSelection(model);
            }
        }

        function switchVideoMode(mode) {
            if (!state.isProcessing) {
                modeController.switchMode(mode);
            }
        }

        // 连接IP摄像头函数
        function connectIPCamera(rtspUrl) {
            // 使用ipCameraController实现RTSP连接
            ipCameraController.connectToCamera(rtspUrl);
        }
        
        // 断开IP摄像头连接
        function disconnectIPCamera() {
            // 使用ipCameraController断开RTSP连接
            ipCameraController.disconnectCamera();
        }

        // 保存RTSP地址到本地存储
        function saveRtspUrl(url) {
            try {
                localStorage.setItem('lastRtspUrl', url);
                console.log('已保存RTSP地址到本地存储');
            } catch (error) {
                console.error('保存RTSP地址时出错:', error);
            }
        }
        
        // 从本地存储加载RTSP地址
        function loadSavedRtspUrl() {
            try {
                const savedUrl = localStorage.getItem('lastRtspUrl');
                if (savedUrl && elements.ipCameraInput) {
                    elements.ipCameraInput.value = savedUrl;
                    console.log('已从本地存储加载RTSP地址');
                }
            } catch (error) {
                console.error('加载RTSP地址时出错:', error);
            }
        }

        // 删除 analyzeRTSP 函数
        // 删除 displayRTSPStream 函数
        // 删除相关的变量和事件监听器

        // 以下未使用的函数已删除:
        // - analyzeImage
        // - displayResult
        // - displayStatus
        // - formatTimestamp
        
        // 切换功能区域
        function switchFeatureMode(mode) {
            try {
                // 停止分析（如果正在进行）
                if (analysisController.isAnalyzing) {
                    analysisController.stopAnalysis();
                }
                
                // 停止智能分析（如果正在进行）
                if (typeof intelligentAnalysisController !== 'undefined' && 
                    intelligentAnalysisController.isAnalyzing) {
                    intelligentAnalysisController.stopIntelligentAnalysis();
                }
                
                // 更新按钮状态
                const searchModeBtn = document.getElementById('searchModeBtn');
                const newFeatureBtn = document.getElementById('newFeatureBtn');
                const scenarioModeBtn = document.getElementById('scenarioModeBtn');
                
                if (mode === 'search') {
                    // 激活搜索模式
                    searchModeBtn.classList.add('active');
                    searchModeBtn.classList.remove('btn-outline-primary');
                    searchModeBtn.classList.add('btn-primary');
                    
                    newFeatureBtn.classList.remove('active');
                    newFeatureBtn.classList.remove('btn-primary');
                    newFeatureBtn.classList.add('btn-outline-primary');
                    
                    scenarioModeBtn.classList.remove('active');
                    scenarioModeBtn.classList.remove('btn-primary');
                    scenarioModeBtn.classList.add('btn-outline-primary');
                    
                    // 显示搜索相关卡片，隐藏新功能卡片
                    document.querySelectorAll('.feature-section').forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });
                    
                    const searchTargetCard = document.getElementById('searchTargetCard');
                    const searchResultCard = document.getElementById('searchResultCard');
                    
                    if (searchTargetCard) {
                        searchTargetCard.classList.add('active');
                        searchTargetCard.style.display = 'block';
                    }
                    
                    if (searchResultCard) {
                        searchResultCard.classList.add('active');
                        searchResultCard.style.display = 'block';
                    }
                } else if (mode === 'newFeature') {
                    // 激活新功能模式
                    newFeatureBtn.classList.add('active');
                    newFeatureBtn.classList.remove('btn-outline-primary');
                    newFeatureBtn.classList.add('btn-primary');
                    
                    searchModeBtn.classList.remove('active');
                    searchModeBtn.classList.remove('btn-primary');
                    searchModeBtn.classList.add('btn-outline-primary');
                    
                    scenarioModeBtn.classList.remove('active');
                    scenarioModeBtn.classList.remove('btn-primary');
                    scenarioModeBtn.classList.add('btn-outline-primary');
                    
                    // 显示新功能卡片，隐藏搜索相关卡片
                    document.querySelectorAll('.feature-section').forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });
                    
                    const newFeatureCard = document.getElementById('newFeatureCard');
                    if (newFeatureCard) {
                        newFeatureCard.classList.add('active');
                        newFeatureCard.style.display = 'block';
                    }
                } else if (mode === 'scenario') {
                    // 激活特定场景模式
                    scenarioModeBtn.classList.add('active');
                    scenarioModeBtn.classList.remove('btn-outline-primary');
                    scenarioModeBtn.classList.add('btn-primary');
                    
                    searchModeBtn.classList.remove('active');
                    searchModeBtn.classList.remove('btn-primary');
                    searchModeBtn.classList.add('btn-outline-primary');
                    
                    newFeatureBtn.classList.remove('active');
                    newFeatureBtn.classList.remove('btn-primary');
                    newFeatureBtn.classList.add('btn-outline-primary');
                    
                    // 显示特定场景卡片，隐藏搜索相关卡片和新功能卡片
                    document.querySelectorAll('.feature-section').forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });
                    
                    const scenarioCard = document.getElementById('scenarioCard');
                    if (scenarioCard) {
                        scenarioCard.classList.add('active');
                        scenarioCard.style.display = 'block';
                    }
                }
                
                console.log(`已切换到${mode === 'search' ? '搜索目标' : mode === 'newFeature' ? '智能分析' : '特定场景'}模式`);
            } catch (error) {
                console.error('切换功能模式时出错:', error);
            }
        }
        
        // 智能分析控制器
        const intelligentAnalysisController = {
            messages: [],
            isProcessing: false,
            chatResults: [],
            currentFrameIndex: 0,
            isAnalyzing: false,
            intelligentFrameBuffer: [], // 添加帧缓冲区
            
            // 初始化
            init() {
                try {
                    // 绑定发送按钮事件
                    const sendBtn = document.getElementById('sendChatBtn');
                    const chatInput = document.getElementById('chatInput');
                    const stopBtn = document.getElementById('stopIntelligentAnalysisBtn');
                    
                    if (sendBtn && chatInput) {
                        // 点击发送按钮
                        sendBtn.addEventListener('click', () => {
                            this.startIntelligentAnalysis();
                        });
                        
                        // 按Enter键发送消息（Shift+Enter换行）
                        chatInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                this.startIntelligentAnalysis();
                            }
                        });
                    }
                    
                    // 绑定停止按钮事件
                    if (stopBtn) {
                        stopBtn.addEventListener('click', () => {
                            this.stopIntelligentAnalysis();
                        });
                    }
                } catch (error) {
                    console.error('初始化智能分析控制器时出错:', error);
                }
            },
            
            // 停止智能分析
            stopIntelligentAnalysis() {
                this.isAnalyzing = false;
                this.isProcessing = false;
                this.removeIntelligentAnalysisIndicator();
                
                // 如果有剩余的帧需要处理
                if (this.intelligentFrameBuffer && this.intelligentFrameBuffer.length > 0) {
                    this.processBatchIntelligentFrames();
                }
                
                // 更新按钮状态
                this.updateIntelligentAnalysisButtons('idle');
                
                console.log('智能分析已停止');
                uiController.showAlert('info', '智能分析已停止');
            },
            
            // 更新智能分析按钮状态
            updateIntelligentAnalysisButtons(state) {
                const sendBtn = document.getElementById('sendChatBtn');
                const stopBtn = document.getElementById('stopIntelligentAnalysisBtn');
                
                if (state === 'analyzing') {
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 分析中...';
                    stopBtn.style.display = 'inline-block'; // 显示停止按钮
                } else {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="bi bi-send"></i> 开始分析';
                    stopBtn.style.display = 'none'; // 隐藏停止按钮
                }
            },
            
            // 启动智能分析
            startIntelligentAnalysis() {
                try {
                    if (this.isProcessing) {
                        uiController.showAlert('info', '正在处理上一条消息，请稍候');
                        return;
                    }
                    
                    const chatInput = document.getElementById('chatInput');
                    const message = chatInput.value.trim();
                    
                    if (!message) {
                        uiController.showAlert('error', '请输入分析问题');
                        return;
                    }
                    
                    // 检查当前分析方式
                    if (!state.hasUploadedVideo && !state.localCameraActive && !state.ipCameraActive && 
                        !(state.currentMode === 'image' && imageController.hasImage)) {
                        uiController.showAlert('error', '请先上传视频、图片、启动本地摄像头或连接网络摄像头');
                        return;
                    }
                    
                    if (state.hasUploadedVideo && (!state.streamExtractedFrames || state.streamExtractedFrames.length === 0)) {
                        uiController.showAlert('error', '视频帧抽取未完成');
                        return;
                    }
                    
                    // 显示处理中状态
                    this.isProcessing = true;
                    this.isAnalyzing = true;
                    this.currentFrameIndex = 0;
                    this.intelligentFrameBuffer = []; // 重置帧缓冲区
                    
                    // 更新按钮状态
                    this.updateIntelligentAnalysisButtons('analyzing');
                    
                    // 添加用户消息到聊天历史
                    this.addIntelligentAnalysisMessage('user', message);
                    
                    // 清空输入框
                    chatInput.value = '';
                    
                    // 显示等待指示器
                    this.showIntelligentAnalysisIndicator();
                    
                    // 准备开始分析
                    if (state.hasUploadedVideo) {
                        const frameCount = state.streamExtractedFrames.length;
                        uiController.showAlert('info', `开始分析视频，共${frameCount}帧`);
                        this.analyzeIntelligentVideoFrames(message);
                    } else if (state.localCameraActive) {
                        uiController.showAlert('info', '开始分析本地摄像头画面');
                        this.analyzeIntelligentCameraFrame(message, 'local');
                    } else if (state.ipCameraActive) {
                        uiController.showAlert('info', '开始分析网络摄像头画面');
                        this.analyzeIntelligentCameraFrame(message, 'ip');
                    } else if (state.currentMode === 'image' && imageController.hasImage) {
                        uiController.showAlert('info', '开始分析图片');
                        this.analyzeIntelligentImage(message);
                    }
                } catch (error) {
                    console.error('启动智能分析时出错:', error);
                    this.isProcessing = false;
                    this.isAnalyzing = false;
                    this.removeIntelligentAnalysisIndicator();
                    this.updateIntelligentAnalysisButtons('idle');
                    uiController.showAlert('error', '分析时出错: ' + error.message);
                }
            },
            
            // 分析视频帧
            async analyzeIntelligentVideoFrames(message) {
                try {
                    // 使用用户设置的帧间隔
                    const frameInterval = fileController.getFrameInterval();
                    console.log(`智能分析使用帧间隔: ${frameInterval}秒`);
                    
                    const frameCount = state.streamExtractedFrames.length;
                    const batchSize = 3; // 每批处理的帧数
                    
                    // 更新UI显示开始分析
                    uiController.showAlert('info', `开始智能分析 ${frameCount} 帧, 间隔 ${frameInterval}秒`);
                    // 使用状态指示器显示开始分析信息
                    this.showAnalysisStatus(`开始分析，共 ${frameCount} 帧, 间隔 ${frameInterval}秒`);
                    
                    // 批量处理所有帧
                    for (let i = 0; i < frameCount; i += batchSize) {
                        // 如果分析已停止，则退出循环
                        if (!this.isAnalyzing) {
                            console.log('智能分析已停止');
                            break;
                        }
                        
                        const batchEnd = Math.min(i + batchSize, frameCount);
                        
                        // 添加当前批次帧到缓冲区
                        for (let j = i; j < batchEnd; j++) {
                            const frameImage = state.streamExtractedFrames[j].dataUrl;
                            if (!frameImage) {
                                console.warn(`帧 #${j + 1} 图像数据无效`);
                                continue;
                            }
                            
                            const processedImage = await imagePreprocessor.preprocessImage(frameImage);
                            
                            // 添加到缓冲区
                            this.intelligentFrameBuffer.push({
                                timestamp: Date.now(),
                                frameNumber: j + 1,
                                image: processedImage,
                                message: message,
                                videoTime: state.streamExtractedFrames[j].time
                            });
                        }
                        
                        // 处理当前批次
                        await this.processBatchIntelligentFrames();
                        
                        // 更新进度显示，但减少更新频率，只在每处理10%的帧时更新一次
                        const progress = Math.min(((i + batchSize) / frameCount * 100), 100).toFixed(1);
                        if (i + batchSize < frameCount) {
                            // 使用状态指示器显示进度
                            this.showAnalysisStatus(`已分析 ${Math.min(i + batchSize, frameCount)}/${frameCount} 帧`, parseFloat(progress));
                        }
                        
                        // 给UI线程一些时间更新
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                    
                    // 确保所有结果已显示并且按正确顺序排序
                    this.sortIntelligentResults();
                    this.displayIntelligentAnalysisResults();
                    this.removeIntelligentAnalysisIndicator();
                    this.isProcessing = false;
                    this.isAnalyzing = false;
                    
                    // 更新按钮状态
                    this.updateIntelligentAnalysisButtons('idle');
                    
                    // 分析完成提示
                    uiController.showAlert('success', '智能分析完成');
                    // 移除"分析完成"系统消息，避免结果卡片缩放
                } catch (error) {
                    console.error('分析视频帧时出错:', error);
                    this.removeIntelligentAnalysisIndicator();
                    this.addIntelligentAnalysisMessage('assistant', `分析视频时出错: ${error.message || '未知错误'}`);
                    this.isProcessing = false;
                    this.isAnalyzing = false;
                }
            },
            
            // 添加排序智能分析结果的方法
            sortIntelligentResults() {
                try {
                    if (this.chatResults.length === 0) return;
                    
                    console.log("对智能分析结果进行排序");
                    
                    // 如果是视频模式且有时间戳，按时间戳排序
                    if (state.hasUploadedVideo) {
                        // 视频模式：按视频时间点排序（升序，最早的在前面）
                        this.chatResults.sort((a, b) => {
                            // 使用视频时间点作为主要排序依据
                            if (a.videoTime !== undefined && b.videoTime !== undefined) {
                                return a.videoTime - b.videoTime;
                                }
                            // 回退到帧号排序
                            return a.frameNumber - b.frameNumber;
                        });
                        console.log("已按视频时间点对智能分析结果排序");
                            } else {
                        // 实时流模式：按帧号排序（升序，最早的在前面）
                        this.chatResults.sort((a, b) => a.frameNumber - b.frameNumber);
                        console.log("已按帧号对智能分析结果排序");
                            }
                } catch (error) {
                    console.error('排序智能分析结果时出错:', error);
                }
            },
            
            // 分析单张图片
            async analyzeIntelligentImage(message) {
                try {
                    console.log('开始分析图片');
                    // 不再添加"正在分析"系统消息，而是使用状态指示器
                    this.showAnalysisStatus('正在分析图片...');
                    
                    // 从imageController获取图片数据
                    const imageData = imageController.getImageData();
                    if (!imageData) {
                        uiController.showAlert('error', '无法获取图片数据');
                        this.removeIntelligentAnalysisIndicator();
                        this.isProcessing = false;
                        this.isAnalyzing = false;
                        this.updateIntelligentAnalysisButtons('idle');
                        return;
                    }
                    
                    // 预处理图像
                    const processedImage = await imagePreprocessor.preprocessImage(imageData);
                    
                    // 调用模型API进行分析
                    const result = await this.callIntelligentModelAPI(processedImage, message);
                    
                    // 添加结果
                    this.chatResults.push({
                        timestamp: Date.now(),
                        frameNumber: 1, // 单张图片只有一帧
                        frameImage: processedImage,
                        message: message,
                        response: result.response,
                        videoTime: null // 图片没有时间戳
                    });
                    
                    // 显示结果
                    this.displayIntelligentAnalysisResults();
                    
                    // 分析完成
                    this.removeIntelligentAnalysisIndicator();
                    this.isProcessing = false;
                    this.isAnalyzing = false;
                    this.updateIntelligentAnalysisButtons('idle');
                    
                    uiController.showAlert('success', '图片分析完成');
                    // 不再添加"分析完成"系统消息，避免结果显示界面缩放
                    
                } catch (error) {
                    console.error('分析图片时出错:', error);
                    this.removeIntelligentAnalysisIndicator();
                    this.addIntelligentAnalysisMessage('assistant', `分析图片时出错: ${error.message || '未知错误'}`);
                    this.isProcessing = false;
                    this.isAnalyzing = false;
                    this.updateIntelligentAnalysisButtons('idle');
                }
            },
            
            // 批量处理智能分析帧
            async processBatchIntelligentFrames() {
                try {
                    if (this.intelligentFrameBuffer.length === 0) return;
                    
                    const bufferSize = this.intelligentFrameBuffer.length;
                    console.log(`开始批量处理 ${bufferSize} 帧智能分析`);
                    
                    // 创建批处理任务
                    const batchPromises = this.intelligentFrameBuffer.map(async (frameData) => {
                        // 分析每一帧
                        const result = await this.callIntelligentModelAPI(frameData.image, frameData.message);
                        
                        // 添加结果
                        this.chatResults.push({
                            timestamp: frameData.timestamp,
                            frameNumber: frameData.frameNumber,
                            frameImage: frameData.image,
                            message: frameData.message,
                            response: result.response,
                            videoTime: frameData.videoTime // 更新为传入的视频时间
                        });
                        
                        return result;
                    });
                    
                    // 并行处理所有帧
                    await Promise.all(batchPromises);
                    
                    // 对结果进行排序然后显示
                    this.sortIntelligentResults();
                    this.displayIntelligentAnalysisResults();
                    
                    // 清空缓冲区
                    this.intelligentFrameBuffer = [];
                    
                    // 注意：移除了每批次处理后显示提示窗口的逻辑，避免频繁闪烁
                    // 只在analyzeIntelligentVideoFrames主函数中的最终结果显示提示
                    
                } catch (error) {
                    console.error('批量处理智能分析帧时出错:', error);
                    this.intelligentFrameBuffer = []; // 出错时也清空缓冲区
                }
            },
            
            // 显示智能分析结果
            displayIntelligentAnalysisResults() {
                try {
                    if (this.chatResults.length === 0) {
                        this.addIntelligentAnalysisMessage('assistant', "分析未返回任何结果，请重试。");
                        return;
                    }
                    
                    // 获取聊天历史容器
                    const chatHistory = document.getElementById('chatHistory');
                    
                    // 显示新结果
                    // 注意：我们假设新的结果只添加到chatResults数组的末尾，函数每次调用只处理新添加的结果
                    // 获取最新添加的结果
                    const newResults = this.chatResults.filter(result => !result.displayed);
                    
                    if (newResults.length === 0) {
                        return; // 没有新结果
                    }
                    
                    // 清除typing指示器
                    this.removeIntelligentAnalysisIndicator();
                    
                    // 首次显示结果时，清空历史
                    if (this.messages.length <= 1 && this.chatResults.length === newResults.length) {
                        chatHistory.innerHTML = '';
                    }
                    
                    // 构建HTML
                    let resultHTML = '';
                    
                    // 添加所有新结果
                    for (const result of newResults) {
                        let responseText = result.response;
                        if (!responseText && result.description) {
                            responseText = result.description;
                        }
                        if (!responseText) {
                            responseText = "模型未返回有效回复";
                        }
                        
                        // 格式化时间显示
                        const timeDisplay = new Date(result.timestamp).toLocaleTimeString();
                        let videoTimeDisplay = '';
                        
                        // 如果有视频时间，则显示
                        if (result.videoTime !== null && result.videoTime !== undefined) {
                            const minutes = Math.floor(result.videoTime / 60);
                            const seconds = Math.floor(result.videoTime % 60);
                            const milliseconds = Math.floor((result.videoTime % 1) * 100);
                            videoTimeDisplay = `<span class="result-video-time">视频时间: ${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}</span>`;
                        }
                        
                        resultHTML += `
                            <div class="result-item">
                                <div class="result-header">
                                    <span class="result-timestamp">${timeDisplay}</span>
                                    <span class="result-frame-number">帧 #${result.frameNumber}</span>
                                    ${videoTimeDisplay}
                                </div>
                                <div class="result-content">
                                    <div class="result-frame">
                                        <img src="${result.frameImage}" alt="Frame ${result.frameNumber}">
                                    </div>
                                    <div class="result-info">
                                        <div class="result-description">${responseText.replace(/\n/g, '<br>')}</div>
                                        <div class="small text-muted mt-2">用户问题: ${result.message}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // 标记为已显示
                        result.displayed = true;
                    }
                    
                    // 添加到聊天历史
                    chatHistory.insertAdjacentHTML('beforeend', resultHTML);
                    
                    // 滚动到底部
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                } catch (error) {
                    console.error('显示智能分析结果时出错:', error);
                    this.addIntelligentAnalysisMessage('assistant', `显示分析结果时出错: ${error.message || '未知错误'}`);
                }
            },
            
            // 添加消息到智能分析历史
            addIntelligentAnalysisMessage(role, content) {
                try {
                    const chatHistory = document.getElementById('chatHistory');
                    if (this.messages.length === 0) {
                        chatHistory.innerHTML = '';
                    }
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${role}`;
                    const formattedContent = content
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>');
                    messageDiv.innerHTML = formattedContent;
                    chatHistory.appendChild(messageDiv);
                    this.messages.push({ role, content });
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                } catch (error) {
                    console.error('添加消息到智能分析历史时出错:', error);
                }
            },
            
            // 显示智能分析打字指示器
            showIntelligentAnalysisIndicator() {
                // 显示分析指示器
                this.showAnalysisStatus('正在准备分析...');
            },
            
            // 移除智能分析打字指示器
            removeIntelligentAnalysisIndicator() {
                // 隐藏分析指示器
                this.hideAnalysisStatus();
            },
            
            // 清空智能分析历史
            clearIntelligentAnalysisHistory() {
                try {
                    const chatHistory = document.getElementById('chatHistory');
                    chatHistory.innerHTML = `<div class="text-center text-muted py-4">
                        <i class="bi bi-chat-square-text" style="font-size: 2rem;"></i>
                        <p class="mt-2">智能分析结果</p>
                    </div>`;
                    this.messages = [];
                    this.chatResults = [];
                    this.currentFrameIndex = 0;
                    this.intelligentFrameBuffer = []; // 清空帧缓冲区
                } catch (error) {
                    console.error('清空智能分析历史时出错:', error);
                }
            },
            
            // 添加系统消息到智能分析历史
            addIntelligentSystemMessage(message) {
                const chatHistory = document.getElementById('chatHistory');
                if (this.messages.length === 0) {
                    chatHistory.innerHTML = '';
                }
                
                // 检查是否有之前的系统消息仍在显示，如果有，则移除
                const existingSystemMsgs = chatHistory.querySelectorAll('.alert.alert-info');
                existingSystemMsgs.forEach(msg => {
                    if (msg.style.opacity !== '0') {
                        msg.style.transition = 'opacity 0.3s';
                        msg.style.opacity = '0';
                        setTimeout(() => {
                            msg.remove();
                        }, 300);
                    }
                });
                
                const systemDiv = document.createElement('div');
                systemDiv.className = 'alert alert-info m-2 p-2';
                systemDiv.innerHTML = `<i class="bi bi-info-circle me-2"></i>${message}`;
                chatHistory.appendChild(systemDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                // 保持系统消息显示5秒后淡出
                setTimeout(() => {
                    systemDiv.style.transition = 'opacity 0.5s';
                    systemDiv.style.opacity = '0';
                    setTimeout(() => {
                        systemDiv.remove();
                    }, 500);
                }, 5000);
            },
            
            // 调用模型API进行智能分析
            async callIntelligentModelAPI(frameImage, message) {
                try {
                    const chatPrompt = [
                        message,
                        "mode=intelligent_analysis"
                    ];
                    const result = await ModelAPIService.analyzeImage(state.selectedModel, frameImage, chatPrompt);
                    if (!result.response && result.description) {
                        result.response = result.description;
                    }
                    if (!result.response) {
                        result.response = `使用${state.selectedModel}模型分析了您的问题:"${message}"，但未能获得有效回复。`;
                    }
                    return result;
                } catch (error) {
                    console.error('调用模型API进行智能分析时出错:', error);
                    return {
                        response: `分析时发生错误: ${error.message || '未知错误'}`,
                        error: true
                    };
                }
            },
            
            // 分析摄像头画面（采用3帧批量处理模式）
            async analyzeIntelligentCameraFrame(message, cameraType, continueFromIndex = null) {
                try {
                    this.isAnalyzing = true;
                    
                    // 仅在首次调用时重置索引，而不是每次重新递归调用
                    if (continueFromIndex === null) {
                        this.currentFrameIndex = 0;
                        // 首次启动时显示分析开始提示
                        // 使用状态指示器显示开始分析信息
                        this.showAnalysisStatus(`开始分析${cameraType === 'local' ? '本地' : '网络'}摄像头画面`);
                    }
                    
                    // 创建帧收集循环
                    const captureFrameInterval = setInterval(async () => {
                        if (!this.isAnalyzing) {
                            clearInterval(captureFrameInterval);
                            return;
                        }
                        
                        let frameImage;
                        if (cameraType === 'local') {
                            frameImage = streamController.captureCurrentFrame();
                        } else if (cameraType === 'ip') {
                            if (typeof ipCameraController !== 'undefined' && typeof ipCameraController.captureFrame === 'function') {
                                frameImage = ipCameraController.captureFrame();
                            } else if (typeof streamController.captureIpCameraFrame === 'function') {
                                frameImage = streamController.captureIpCameraFrame();
                            } else {
                                const img = document.getElementById('ipCameraStream');
                                if (img && img.complete && img.naturalWidth > 0) {
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    canvas.width = img.naturalWidth;
                                    canvas.height = img.naturalHeight;
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    frameImage = canvas.toDataURL('image/jpeg', 0.85);
                                }
                            }
                        }
                        
                        if (!frameImage) {
                            console.warn('无法获取摄像头画面，将在下次尝试');
                            return;
                        }
                        
                        // 处理图像
                        const processedImage = await imagePreprocessor.preprocessImage(frameImage);
                        
                        // 将处理后的帧添加到缓冲区
                        this.intelligentFrameBuffer.push({
                            timestamp: Date.now(),
                            frameNumber: this.currentFrameIndex + 1,
                            image: processedImage,
                            message: message
                        });
                        
                        this.currentFrameIndex++;
                        
                        // 当收集到3帧或实时流分析停止时，处理缓冲区
                        if (this.intelligentFrameBuffer.length >= 3 || !this.isAnalyzing) {
                            clearInterval(captureFrameInterval); // 暂停采集
                            await this.processBatchIntelligentFrames();
                            
                            // 如果分析仍在进行，重新启动采集
                            if (this.isAnalyzing) {
                                // 每10帧更新一次进度提示（而不是每批次都提示）
                                if (this.currentFrameIndex % 10 === 0) {
                                    // 使用状态指示器显示进度
                                    this.showAnalysisStatus(`已分析 ${this.currentFrameIndex} 帧`);
                                }
                                
                                // 传递当前帧索引，保持递增
                                this.analyzeIntelligentCameraFrame(message, cameraType, this.currentFrameIndex);
                            } else {
                                this.isProcessing = false;
                            }
                        }
                        
                    }, 1000); // 每秒采集一帧
                    
                } catch (error) {
                    console.error('分析摄像头画面时出错:', error);
                    this.removeIntelligentAnalysisIndicator();
                    this.addIntelligentAnalysisMessage('assistant', `分析摄像头画面时出错: ${error.message || '未知错误'}`);
                    this.isProcessing = false;
                    this.isAnalyzing = false;
                }
            },
            
            // 添加显示分析状态的方法
            showAnalysisStatus(message, progress = -1) {
                const statusIndicator = document.getElementById('analysisStatusIndicator');
                const statusText = document.getElementById('analysisStatusText');
                const progressBar = document.getElementById('analysisProgressBar');
                
                if (!statusIndicator || !statusText || !progressBar) return;
                
                // 显示状态区
                statusIndicator.style.display = 'block';
                statusText.textContent = message;
                
                // 设置进度条，如果提供了进度
                if (progress >= 0) {
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress);
                }
            },
            
            // 隐藏分析状态
            hideAnalysisStatus() {
                const statusIndicator = document.getElementById('analysisStatusIndicator');
                if (statusIndicator) {
                    statusIndicator.style.display = 'none';
                }
            },
        };
        
        // 在DOMContentLoaded时初始化智能分析控制器和特定场景控制器
        document.addEventListener('DOMContentLoaded', () => {
            intelligentAnalysisController.init();
            scenarioController.init();  // 初始化特定场景控制器
            
            // 为智能分析结果容器添加额外的样式
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory) {
                // 使样式更接近搜索结果容器
                chatHistory.style.background = '#f8f9fa';
                chatHistory.style.borderRadius = '8px';
                chatHistory.style.padding = '0.5rem';
                
                // 添加滚动条样式
                chatHistory.style.scrollBehavior = 'smooth';
                
                // 添加与搜索结果一致的滚动条样式
                const style = document.createElement('style');
                style.textContent = `
                    #chatHistory::-webkit-scrollbar {
                        width: 6px;
                    }
                    
                    #chatHistory::-webkit-scrollbar-track {
                        background: #f1f1f1;
                        border-radius: 3px;
                    }
                    
                    #chatHistory::-webkit-scrollbar-thumb {
                        background: #888;
                        border-radius: 3px;
                    }
                    
                    #chatHistory::-webkit-scrollbar-thumb:hover {
                        background: #666;
                    }
                    
                    /* 确保结果项在智能分析中也有良好的间距和动画 */
                    #chatHistory .result-item {
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        overflow: hidden;
                        opacity: 0;
                        transform: translateY(20px);
                        animation: resultAppear 0.3s ease forwards;
                    }
                    
                    /* 调整用户聊天消息的样式，确保不与结果项冲突 */
                    #chatHistory .chat-message.user {
                        background-color: var(--primary-color);
                        color: white;
                        margin-left: auto;
                        margin-right: 0;
                        margin-bottom: 1rem;
                        max-width: 80%;
                        padding: 0.75rem 1rem;
                        border-radius: 1rem;
                        border-bottom-right-radius: 0.25rem;
                        display: inline-block;
                    }
                `;
                document.head.appendChild(style);
            }
        });

        function switchVideoMode(mode) {
            if (!state.isProcessing) {
                modeController.switchMode(mode);
            }
        }
    </script>
    
    <!-- 特定场景控制器 -->
    <script>
        // 特定场景控制器
        const scenarioController = {
            selectedScenario: null,
            isAnalyzing: false,
            scenarioFrameBuffer: [],
            currentFrameIndex: 0,
            
            // 初始化
            init() {
                try {
                    // 绑定场景选项点击事件
                    const scenarioOptions = document.querySelectorAll('.scenario-option');
                    scenarioOptions.forEach(option => {
                        option.addEventListener('click', () => {
                            // 取消所有选中状态
                            scenarioOptions.forEach(opt => opt.classList.remove('selected'));
                            // 选中当前选项
                            option.classList.add('selected');
                            // 保存选中的场景
                            this.selectedScenario = option.dataset.scenario;
                            console.log(`已选择场景: ${this.selectedScenario}`);
                        });
                    });
                    
                    // 绑定开始分析按钮事件
                    const startBtn = document.getElementById('startScenarioBtn');
                    const stopBtn = document.getElementById('stopScenarioBtn');
                    
                    if (startBtn) {
                        startBtn.addEventListener('click', () => {
                            this.startScenarioAnalysis();
                        });
                    }
                    
                    if (stopBtn) {
                        stopBtn.addEventListener('click', () => {
                            this.stopScenarioAnalysis();
                        });
                    }
                } catch (error) {
                    console.error('初始化特定场景控制器时出错:', error);
                }
            },
            
            // 更新分析按钮状态
            updateScenarioButtons(state) {
                const startBtn = document.getElementById('startScenarioBtn');
                const stopBtn = document.getElementById('stopScenarioBtn');
                
                if (state === 'analyzing') {
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 分析中...';
                    stopBtn.style.display = 'inline-block'; // 显示停止按钮
                } else {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="bi bi-play-fill"></i> 开始分析';
                    stopBtn.style.display = 'none'; // 隐藏停止按钮
                }
            },
            
            // 开始场景分析
            startScenarioAnalysis() {
                try {
                    if (this.isAnalyzing) {
                        uiController.showAlert('info', '分析已在进行中');
                        return;
                    }
                    
                    if (!this.selectedScenario) {
                        uiController.showAlert('error', '请先选择一个场景');
                        return;
                    }
                    
                    // 检查当前分析方式
                    if (!state.hasUploadedVideo && !state.localCameraActive && !state.ipCameraActive && 
                        !(state.currentMode === 'image' && imageController.hasImage)) {
                        uiController.showAlert('error', '请先上传视频、图片、启动本地摄像头或连接网络摄像头');
                        return;
                    }
                    
                    // 设置分析状态
                    this.isAnalyzing = true;
                    this.currentFrameIndex = 0;
                    this.scenarioFrameBuffer = [];
                    // 清除已分析时间点记录
                    this.analyzedVideoTimes = new Set();
                    // 重置待处理请求计数
                    this.pendingRequests = 0;
                    
                    // 更新按钮状态
                    this.updateScenarioButtons('analyzing');
                    
                    // 清空结果区域
                    this.clearScenarioResults();
                    
                    // 添加加载提示
                    this.addLoadingIndicator();
                    
                    // 设置提示语
                    let prompt = '';
                    switch (this.selectedScenario) {
                        case 'server-room':
                            prompt = '分析当前画面：1. 交换机是否出现指示灯异常、端口故障等问题？2. 画面中是否有人员经过？如有，描述其位置和行为。3. 设备是否有过热、冒烟等异常情况？';
                            break;
                        case 'pollution':
                            prompt = '分析当前画面：1. 是否存在垃圾乱扔现象？2. 如有垃圾，描述其类型、位置和数量。3. 周围环境是否整洁？4. 是否有人正在进行不当处理废弃物的行为？';
                            break;
                        case 'fire':
                            prompt = '分析当前画面：1. 是否存在明火、烟雾或其他火灾迹象？2. 如有火情，描述火势大小、位置和蔓延趋势。3. 画面中是否有易燃物品处于危险位置？4. 是否有人员被困在火场中？';
                            break;
                        case 'illegal-parking':
                            prompt = '分析当前画面：1. 是否存在车辆违规停放现象？包括但不限于：占用消防通道、盲道、人行道、禁停区域等。2. 如发现违停车辆，请描述车辆类型、颜色、位置和违停类型。3. 违停行为是否影响交通通行或造成安全隐患？4. 周围是否有相关的禁停标识或标线？5. 请评估违停行为的严重程度并提出处理建议。';
                            break;
                        case 'custom':
                            prompt = '请分析画面中的异常情况，包括但不限于设备故障、环境异常、安全隐患等。';
                            break;
                        default:
                            prompt = '请分析画面中可能存在的异常情况。';
                    }
                    
                    // 根据当前模式获取帧
                    if (state.localCameraActive || state.ipCameraActive) {
                        // 实时摄像头模式 - 抓取当前帧并分析
                        this.captureAndAnalyzeCurrentFrame(prompt);
                    } else if (state.hasUploadedVideo) {
                        // 视频模式 - 定时抓取帧并分析
                        const frameInterval = CONFIG.defaultFrameInterval * 1000; // 转换为毫秒
                        this.analyzeVideoFrames(prompt, frameInterval);
                    } else if (state.currentMode === 'image' && imageController.hasImage) {
                        // 图片模式 - 直接分析图片
                        this.analyzeImage(prompt);
                    }
                } catch (error) {
                    console.error('启动场景分析时出错:', error);
                    this.stopScenarioAnalysis();
                    uiController.showAlert('error', '启动场景分析时出错');
                }
            },
            
            // 停止场景分析
            stopScenarioAnalysis() {
                this.isAnalyzing = false;
                this.updateScenarioButtons('idle');
                this.removeLoadingIndicator();
                // 重置待处理请求计数
                this.pendingRequests = 0;
                
                console.log('场景分析已停止');
                uiController.showAlert('info', '场景分析已停止');
            },
            
            // 抓取并分析当前帧
            captureAndAnalyzeCurrentFrame(prompt) {
                try {
                    if (!this.isAnalyzing) return;
                    
                    let videoElement;
                    if (state.localCameraActive) {
                        videoElement = document.getElementById('streamVideo');
                    } else if (state.ipCameraActive) {
                        videoElement = document.getElementById('ipCameraVideo');
                    }
                    
                    if (!videoElement || !videoElement.videoWidth) {
                        setTimeout(() => this.captureAndAnalyzeCurrentFrame(prompt), 500);
                        return;
                    }
                    
                    // 创建canvas和截取视频帧
                    const canvas = document.createElement('canvas');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    // 获取图像数据
                    const imageData = canvas.toDataURL('image/jpeg', CONFIG.frameQuality);
                    
                    // 分析图像
                    this.analyzeImageData(imageData, prompt);
                    
                    // 如果仍在分析，设置下一次抓取
                    if (this.isAnalyzing) {
                        setTimeout(() => this.captureAndAnalyzeCurrentFrame(prompt), 5000); // 每5秒钟分析一次
                    }
                } catch (error) {
                    console.error('抓取和分析当前帧时出错:', error);
                    if (this.isAnalyzing) {
                        setTimeout(() => this.captureAndAnalyzeCurrentFrame(prompt), 2000);
                    }
                }
            },
            
            // 记录待处理的请求数量
            pendingRequests: 0,
            
            // 分析视频帧
            analyzeVideoFrames(prompt, frameInterval) {
                try {
                    if (!this.isAnalyzing) return;
                    
                    if (!state.streamExtractedFrames || state.streamExtractedFrames.length === 0) {
                        uiController.showAlert('error', '视频帧抽取未完成');
                        this.stopScenarioAnalysis();
                        return;
                    }
                    
                    // 获取当前帧
                    const currentFrame = state.streamExtractedFrames[this.currentFrameIndex];
                    
                    // 检查帧数据，确定正确的图像数据属性（dataUrl或data）
                    const frameImageData = currentFrame.dataUrl || currentFrame.data;
                    
                    // 确保有有效的图像数据
                    if (!frameImageData) {
                        console.error('无法获取帧图像数据');
                        uiController.showAlert('error', '无法获取视频帧');
                        this.stopScenarioAnalysis();
                        return;
                    }
                    
                    // 获取当前帧的视频时间（秒）
                    const videoTime = currentFrame.time || this.currentFrameIndex * CONFIG.defaultFrameInterval;
                    
                    // 递增待处理请求计数器
                    this.pendingRequests++;
                    
                    // 分析图像，传递视频时间和标记是否为最后一帧
                    const isLastFrame = this.currentFrameIndex >= state.streamExtractedFrames.length - 1;
                    this.analyzeImageData(frameImageData, prompt, currentFrame.timestamp, videoTime, isLastFrame);
                    
                    // 更新帧索引
                    this.currentFrameIndex++;
                    
                    // 检查是否已发送所有帧的分析请求
                    if (this.currentFrameIndex >= state.streamExtractedFrames.length) {
                        console.log('已发送所有视频帧分析请求，共 ' + state.streamExtractedFrames.length + ' 帧，等待后端处理完成...');
                        // 注意：我们不在这里停止分析，而是等待所有请求完成
                        return; // 不再继续发送请求
                    }
                    
                    // 如果仍在分析，设置下一次分析
                    if (this.isAnalyzing) {
                        setTimeout(() => this.analyzeVideoFrames(prompt, frameInterval), frameInterval);
                    }
                } catch (error) {
                    console.error('分析视频帧时出错:', error);
                    this.stopScenarioAnalysis();
                }
            },
            
            // 分析图片
            analyzeImage(prompt) {
                try {
                    if (!imageController.hasImage) {
                        uiController.showAlert('error', '请先上传图片');
                        this.stopScenarioAnalysis();
                        return;
                    }
                    
                    const imageElement = document.getElementById('imagePreview');
                    
                    // 创建canvas和截取图片
                    const canvas = document.createElement('canvas');
                    canvas.width = imageElement.naturalWidth;
                    canvas.height = imageElement.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
                    
                    // 获取图像数据
                    const imageData = canvas.toDataURL('image/jpeg', CONFIG.frameQuality);
                    
                    // 分析图像
                    this.analyzeImageData(imageData, prompt);
                } catch (error) {
                    console.error('分析图片时出错:', error);
                    this.stopScenarioAnalysis();
                }
            },
            
            // 分析图像数据
            analyzeImageData(imageData, prompt, timestamp = null, videoTime = null, isLastFrame = false) {
                try {
                    // 准备分析数据
                    const data = {
                        model: state.selectedModel,
                        image: imageData,
                        prompt: prompt
                    };
                    
                    console.log(`发送场景分析请求: 场景=${this.selectedScenario}, 模型=${state.selectedModel}`);
                    
                    // 添加调试信息
                    if (!imageData) {
                        console.error('分析数据中图像数据为空');
                        uiController.showAlert('error', '无法获取图像数据');
                        return;
                    }
                    
                    // 检查图像数据格式是否正确
                    if (typeof imageData !== 'string' || !imageData.startsWith('data:image')) {
                        console.error('图像数据格式无效，应为base64编码的数据URL');
                        console.log('图像数据类型:', typeof imageData);
                        console.log('图像数据预览:', imageData ? imageData.substring(0, 50) + '...' : '空');
                        uiController.showAlert('error', '图像数据格式无效');
                        return;
                    }
                    
                    // 添加请求状态指示
                    this.addScenarioResult('正在分析场景中...', timestamp, imageData, videoTime);
                    
                    fetch('/api/analyze-scenario', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`网络响应异常 (${response.status}: ${response.statusText})`);
                        }
                        return response.json();
                    })
                    .then(result => {
                        console.log('场景分析结果:', result);
                        
                        if (this.isAnalyzing) {
                            // 移除加载指示器
                            this.removeLoadingIndicator();
                            
                            // 检查结果格式
                            if (!result || !result.text) {
                                throw new Error('返回的结果格式无效，缺少text字段');
                            }
                            
                            // 清除所有的"正在分析"临时消息
                            const resultsContainer = document.getElementById('scenarioResultsContainer');
                            if (resultsContainer) {
                                const pendingMsgs = resultsContainer.querySelectorAll('.scenario-result');
                                pendingMsgs.forEach(msg => {
                                    if (msg.textContent.includes('正在分析场景中')) {
                                        msg.remove();
                                    }
                                });
                            }
                            
                            // 显示分析结果
                            this.addScenarioResult(result.text, timestamp, imageData, videoTime);
                            
                            // 如果是图片模式或单次分析，更新按钮状态
                            if (state.currentMode === 'image' || 
                               (!state.localCameraActive && !state.ipCameraActive && !state.hasUploadedVideo)) {
                                this.isAnalyzing = false;
                                this.updateScenarioButtons('idle');
                            }
                            
                            // 减少待处理请求计数
                            this.pendingRequests--;
                            console.log(`请求完成，剩余待处理请求数: ${this.pendingRequests}`);
                            
                            // 检查是否所有请求都已完成，且这是最后一个分析
                            if (this.pendingRequests <= 0 && isLastFrame) {
                                console.log('所有视频帧分析请求已完成处理');
                                uiController.showAlert('info', '视频分析完成');
                                this.isAnalyzing = false;
                                this.updateScenarioButtons('idle');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('分析图像数据时出错:', error);
                        if (this.isAnalyzing) {
                            // 清除所有的"正在分析"临时消息
                            const resultsContainer = document.getElementById('scenarioResultsContainer');
                            if (resultsContainer) {
                                const pendingMsgs = resultsContainer.querySelectorAll('.scenario-result');
                                pendingMsgs.forEach(msg => {
                                    if (msg.textContent.includes('正在分析场景中')) {
                                        msg.remove();
                                    }
                                });
                            }
                            
                            // 显示失败信息
                            this.addScenarioResult(`分析失败: ${error.message}`, timestamp);
                            
                            // 建议用户尝试的操作
                            this.addScenarioResult('建议: 请检查网络连接并重试，或尝试选择其他模型', null);
                            
                            // 恢复按钮状态
                            this.pendingRequests--;
                            console.log(`请求失败，剩余待处理请求数: ${this.pendingRequests}`);
                            
                            // 如果没有待处理请求，或者这是图片/单次分析，完全停止分析
                            if (this.pendingRequests <= 0 || state.currentMode === 'image' || 
                                (!state.localCameraActive && !state.ipCameraActive && !state.hasUploadedVideo)) {
                                this.isAnalyzing = false;
                                this.updateScenarioButtons('idle');
                            }
                            
                            this.removeLoadingIndicator();
                        }
                    });
                } catch (error) {
                    console.error('发送分析请求时出错:', error);
                    if (this.isAnalyzing) {
                        this.addScenarioResult(`发送分析请求失败: ${error.message}`, timestamp);
                    }
                }
            },
            
            // 存储已分析的视频时间点，用于防止重复
            analyzedVideoTimes: new Set(),
            
            // 添加场景分析结果
            addScenarioResult(text, timestamp = null, imageData = null, videoTime = null) {
                try {
                    const resultsContainer = document.getElementById('scenarioResultsContainer');
                    if (!resultsContainer) return;
                    
                    // 防止视频时间点重复分析（除了"正在分析"的临时消息）
                    if (videoTime !== null && state.hasUploadedVideo && !text.includes('正在分析场景中')) {
                        // 将时间转为2位小数的字符串形式，避免浮点数比较问题
                        const timeKey = videoTime.toFixed(2);
                        
                        // 如果这个时间点已经分析过，跳过
                        if (this.analyzedVideoTimes.has(timeKey)) {
                            console.log(`跳过重复的视频时间点: ${timeKey}秒`);
                            return;
                        }
                        
                        // 记录这个时间点已被分析
                        this.analyzedVideoTimes.add(timeKey);
                    }
                    
                    // 清除初始提示
                    if (resultsContainer.querySelector('.text-muted')) {
                        resultsContainer.innerHTML = '';
                    }
                    
                    // 创建结果元素
                    const resultElement = document.createElement('div');
                    resultElement.className = 'scenario-result';
                    
                    // 格式化时间戳
                    let timeText = '';
                    if (timestamp) {
                        const date = new Date(timestamp);
                        const hours = date.getHours().toString().padStart(2, '0');
                        const minutes = date.getMinutes().toString().padStart(2, '0');
                        const seconds = date.getSeconds().toString().padStart(2, '0');
                        timeText = `${hours}:${minutes}:${seconds}`;
                    } else {
                        const now = new Date();
                        const hours = now.getHours().toString().padStart(2, '0');
                        const minutes = now.getMinutes().toString().padStart(2, '0');
                        const seconds = now.getSeconds().toString().padStart(2, '0');
                        timeText = `${hours}:${minutes}:${seconds}`;
                    }
                    
                    // 获取当前帧的图像数据
                    if (!imageData) {
                        // 尝试从各种来源获取图像数据
                        if (state.currentMode === 'image' && imageController.hasImage) {
                            const imageElement = document.getElementById('imagePreview');
                            if (imageElement) {
                                const canvas = document.createElement('canvas');
                                canvas.width = imageElement.naturalWidth;
                                canvas.height = imageElement.naturalHeight;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
                                imageData = canvas.toDataURL('image/jpeg', CONFIG.frameQuality);
                            }
                        } else if (state.localCameraActive) {
                            imageData = streamController.captureCurrentFrame();
                        } else if (state.ipCameraActive) {
                            imageData = ipCameraController.captureCurrentFrame();
                        } else if (state.hasUploadedVideo && state.streamExtractedFrames && this.currentFrameIndex < state.streamExtractedFrames.length) {
                            imageData = state.streamExtractedFrames[this.currentFrameIndex].dataUrl || state.streamExtractedFrames[this.currentFrameIndex].data;
                        }
                    }
                    
                    // 设置内容
                    let contentHTML = '';
                    
                    // 格式化视频时间显示
                    let videoTimeHTML = '';
                    if (videoTime !== null && videoTime !== undefined && state.hasUploadedVideo) {
                        const minutes = Math.floor(videoTime / 60);
                        const seconds = Math.floor(videoTime % 60);
                        const milliseconds = Math.floor((videoTime % 1) * 100);
                        videoTimeHTML = `<div class="scenario-video-time">视频时间: ${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}</div>`;
                    }
                    
                    // 如果有图像数据，添加图像
                    if (imageData) {
                        contentHTML += `
                            <div class="scenario-result-content">
                                <div class="scenario-frame">
                                    <img src="${imageData}" alt="场景分析图像">
                                </div>
                                <div class="scenario-info">
                                    <div class="scenario-description">${text.replace(/\n/g, '<br>')}</div>
                                    ${videoTimeHTML}
                                </div>
                            </div>
                        `;
                    } else {
                        contentHTML += `
                            <div class="scenario-content">${text.replace(/\n/g, '<br>')}</div>
                            ${videoTimeHTML}
                        `;
                    }
                    
                    contentHTML += `<div class="scenario-timestamp mt-2">时间: ${timeText}</div>`;
                    
                    resultElement.innerHTML = contentHTML;
                    
                    // 添加到容器的顶部
                    resultsContainer.insertBefore(resultElement, resultsContainer.firstChild);
                    
                    // 滚动到顶部
                    resultsContainer.scrollTop = 0;
                } catch (error) {
                    console.error('添加场景分析结果时出错:', error);
                }
            },
            
            // 清空场景分析结果
            clearScenarioResults() {
                try {
                    const resultsContainer = document.getElementById('scenarioResultsContainer');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-buildings" style="font-size: 2rem;"></i>
                                <p class="mt-2">请选择场景并开始分析</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('清空场景分析结果时出错:', error);
                }
            },
            
            // 添加加载指示器
            addLoadingIndicator() {
                try {
                    const resultsContainer = document.getElementById('scenarioResultsContainer');
                    if (!resultsContainer) return;
                    
                    // 清除容器内容
                    resultsContainer.innerHTML = `
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在分析场景，请稍候...</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('添加加载指示器时出错:', error);
                }
            },
            
            // 移除加载指示器
            removeLoadingIndicator() {
                try {
                    const resultsContainer = document.getElementById('scenarioResultsContainer');
                    if (!resultsContainer) return;
                    
                    const loadingIndicator = resultsContainer.querySelector('.spinner-border');
                    if (loadingIndicator) {
                        const parentElement = loadingIndicator.parentElement;
                        if (parentElement && parentElement.classList.contains('text-center')) {
                            parentElement.remove();
                        }
                    }
                } catch (error) {
                    console.error('移除加载指示器时出错:', error);
                }
            }
        };
    </script>
</body>
</html>